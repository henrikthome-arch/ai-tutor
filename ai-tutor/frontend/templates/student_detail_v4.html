{% extends "base.html" %}

{% block title %}{{ student_context.demographics.name or 'Student' }} - AI Tutor Admin{% endblock %}

{% block styles %}
<style>
    /* Enhanced styles for v4 context display */
    .v4-context-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        position: relative;
        overflow: hidden;
    }
    
    .v4-context-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #007bff, #6610f2);
    }
    
    .v4-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    
    .v4-section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .v4-version-badge {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        font-size: 0.7rem;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .demographics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .demo-field {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s ease;
    }
    
    .demo-field:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .demo-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }
    
    .demo-value {
        font-size: 1rem;
        color: #2c3e50;
        font-weight: 500;
    }
    
    .memory-scope-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .memory-scope-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .memory-scope-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    
    .curriculum-atlas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }
    
    .curriculum-subject-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        border-left: 4px solid #007bff;
    }
    
    .curriculum-subject-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .goal-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
    }
    
    .goal-card:hover {
        background: #e9ecef;
        transform: translateX(4px);
    }
    
    .kc-badge {
        background: #e3f2fd;
        color: #1976d2;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        margin: 2px;
        display: inline-block;
    }
    
    .prerequisite-badge {
        background: #fff3e0;
        color: #f57c00;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        margin: 2px;
        display: inline-block;
    }
    
    .progress-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: conic-gradient(#27ae60 var(--progress, 0%), #ecf0f1 0);
        margin: 0 auto 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .progress-circle-inner {
        width: 70px;
        height: 70px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .progress-circle-text {
        font-size: 1.2rem;
        font-weight: bold;
        color: #27ae60;
    }
    
    .tab-button {
        background: #f8f9fa;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 1rem 1.5rem;
        cursor: pointer;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s ease;
    }
    
    .tab-button:hover {
        background: #e9ecef;
        color: #495057;
    }
    
    .tab-button.active {
        background: white;
        color: #2c3e50;
        border-bottom-color: #007bff;
    }
    
    .tab-content {
        display: none;
        padding: 1.5rem;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .json-viewer {
        background: #1e1e1e;
        color: #d4d4d4;
        border-radius: 8px;
        padding: 1.5rem;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.4;
        overflow: auto;
        max-height: 600px;
        border: 1px solid #444;
    }
    
    .json-key {
        color: #9cdcfe;
    }
    
    .json-string {
        color: #ce9178;
    }
    
    .json-number {
        color: #b5cea8;
    }
    
    .json-boolean {
        color: #569cd6;
    }
    
    .json-null {
        color: #569cd6;
    }
    
    .context-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .context-stat {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .context-stat:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .context-stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 0.25rem;
    }
    
    .context-stat-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('main.admin_dashboard') }}">üìä Dashboard</a> /
    <a href="{{ url_for('main.admin_students') }}">üë• Students</a> /
    <span>{{ student_context.demographics.name or 'Student' }}</span>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="color: #2c3e50;">
        {{ student_context.demographics.name or 'Student' }}
        <span class="v4-version-badge">v{{ student_context.context_version or '4' }}</span>
    </h1>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('main.edit_student', student_id=student_context.demographics.student_id) }}" class="btn" style="background: #f39c12; text-decoration: none;">
            ‚úèÔ∏è Edit Student
        </a>
        <button class="btn btn-danger" onclick="deleteStudent('{{ student_context.demographics.student_id }}', '{{ student_context.demographics.name }}')">
            üóëÔ∏è Delete
        </button>
    </div>
</div>

<!-- Context Overview Stats -->
<div class="context-stats">
    <div class="context-stat">
        <div class="context-stat-value">{{ student_context.context_version or '4' }}</div>
        <div class="context-stat-label">Context Version</div>
    </div>
    <div class="context-stat">
        <div class="context-stat-value">{{ student_context.memories.keys()|length if student_context.memories else 0 }}</div>
        <div class="context-stat-label">Memory Scopes</div>
    </div>
    <div class="context-stat">
        <div class="context-stat-value">{{ student_context._curriculum.subjects|length if student_context._curriculum and student_context._curriculum.subjects else 0 }}</div>
        <div class="context-stat-label">Curriculum Subjects</div>
    </div>
    <div class="context-stat">
        <div class="context-stat-value">{{ student_context.progress.overall_mastery_percentage or 0 }}%</div>
        <div class="context-stat-label">Overall Mastery</div>
    </div>
</div>

<!-- Main Content Tabs -->
<div class="card" style="margin-bottom: 2rem;">
    <div style="border-bottom: 1px solid #dee2e6;">
        <nav style="display: flex; gap: 0; margin: -1.5rem -1.5rem 0 -1.5rem;">
            <button class="tab-button active" onclick="showTab('demographics')" id="tab-demographics">
                üë§ Demographics
            </button>
            <button class="tab-button" onclick="showTab('profile')" id="tab-profile">
                üß† AI Profile
            </button>
            <button class="tab-button" onclick="showTab('memories')" id="tab-memories">
                üí≠ Memories
            </button>
            <button class="tab-button" onclick="showTab('progress')" id="tab-progress">
                üìä Progress
            </button>
            <button class="tab-button" onclick="showTab('curriculum')" id="tab-curriculum">
                üìö Curriculum Atlas
            </button>
            <button class="tab-button" onclick="showTab('raw-json')" id="tab-raw-json">
                üîß Raw JSON
            </button>
        </nav>
    </div>
    
    <!-- Demographics Tab -->
    <div id="content-demographics" class="tab-content active">
        <div class="v4-context-section">
            <div class="v4-section-header">
                <div class="v4-section-title">üë§ Student Demographics</div>
                <div style="font-size: 0.8rem; color: #666;">Basic demographic information</div>
            </div>
            
            <div class="demographics-grid">
                <div class="demo-field">
                    <div class="demo-label">Student ID</div>
                    <div class="demo-value" style="font-family: monospace;">{{ student_context.demographics.student_id or 'N/A' }}</div>
                </div>
                
                <div class="demo-field">
                    <div class="demo-label">Full Name</div>
                    <div class="demo-value">{{ student_context.demographics.name or 'N/A' }}</div>
                </div>
                
                <div class="demo-field">
                    <div class="demo-label">Age</div>
                    <div class="demo-value">{{ student_context.demographics.age or 'N/A' }}</div>
                </div>
                
                <div class="demo-field">
                    <div class="demo-label">Grade Level</div>
                    <div class="demo-value">{{ student_context.demographics.grade_level or 'N/A' }}</div>
                </div>
                
                <div class="demo-field">
                    <div class="demo-label">Phone Number</div>
                    <div class="demo-value">
                        {% if student_context.demographics.phone %}
                            <span style="color: #27ae60;">üì± {{ student_context.demographics.phone }}</span>
                        {% else %}
                            <span style="color: #e74c3c;">‚ùå Not configured</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="demo-field">
                    <div class="demo-label">School</div>
                    <div class="demo-value">{{ student_context.demographics.school or 'N/A' }}</div>
                </div>
                
                <div class="demo-field">
                    <div class="demo-label">Created</div>
                    <div class="demo-value">{{ student_context.demographics.created_at or 'N/A' }}</div>
                </div>
                
                <div class="demo-field">
                    <div class="demo-label">Last Updated</div>
                    <div class="demo-value">{{ student_context.demographics.updated_at or 'N/A' }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Profile Tab -->
    <div id="content-profile" class="tab-content">
        <div class="v4-context-section">
            <div class="v4-section-header">
                <div class="v4-section-title">üß† AI-Generated Profile</div>
                <div style="font-size: 0.8rem; color: #666;">AI analysis and personality insights</div>
            </div>
            
            {% if student_context.profile %}
                {% if student_context.profile.narrative %}
                <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #1976d2; margin: 0 0 0.5rem 0;">üí´ AI Narrative</h4>
                    <p style="margin: 0; font-style: italic; color: #1565c0;">{{ student_context.profile.narrative }}</p>
                </div>
                {% endif %}
                
                {% if student_context.profile.traits %}
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">üé≠ Personality Traits</h4>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        {% for category, traits in student_context.profile.traits.items() %}
                            {% if traits is iterable and traits is not string %}
                                {% for trait in traits %}
                                    <span class="kc-badge">{{ category }}: {{ trait }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="kc-badge">{{ category }}: {{ traits }}</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if student_context.profile.ai_generated_insights %}
                <div style="background: #f0f9f0; border-left: 4px solid #4caf50; padding: 1rem; border-radius: 8px;">
                    <h4 style="color: #388e3c; margin: 0 0 0.5rem 0;">ü§ñ AI Insights</h4>
                    <div style="color: #2e7d32;">{{ student_context.profile.ai_generated_insights }}</div>
                </div>
                {% endif %}
            {% else %}
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üß†</div>
                    <h4>No AI Profile Available</h4>
                    <p>This student's profile is being generated by our AI system.</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Memories Tab -->
    <div id="content-memories" class="tab-content">
        <div class="v4-context-section">
            <div class="v4-section-header">
                <div class="v4-section-title">üí≠ Tutor Memory System</div>
                <div style="font-size: 0.8rem; color: #666;">Scoped memory storage for personalized learning</div>
            </div>
            
            {% if student_context.memories %}
                <div class="memory-scope-container">
                    {% for scope_name, scope_data in student_context.memories.items() %}
                    <div class="memory-scope-card">
                        <div style="background: #f8f9fa; padding: 1rem; border-bottom: 1px solid #dee2e6;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; color: #2c3e50;">
                                        {% if scope_name == 'personal_fact' %}üë§ Personal Facts
                                        {% elif scope_name == 'game_state' %}üéÆ Game State
                                        {% elif scope_name == 'strategy_log' %}üìö Strategy Log
                                        {% else %}üìù {{ scope_name|title }}
                                        {% endif %}
                                    </h4>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                        {{ scope_data.keys()|length if scope_data else 0 }} memories stored
                                    </div>
                                </div>
                                <button class="btn" style="background: #28a745; color: white; font-size: 0.8rem; padding: 6px 12px;" 
                                        onclick="addMemoryEntry('{{ scope_name }}')">
                                    ‚ûï Add
                                </button>
                            </div>
                        </div>
                        <div style="padding: 1rem;">
                            {% if scope_data %}
                                {% for key, value in scope_data.items() %}
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #f1f3f4;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #495057; font-size: 0.9rem;">{{ key }}</div>
                                        <div style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">{{ value }}</div>
                                    </div>
                                    <div style="display: flex; gap: 0.25rem;">
                                        <button onclick="editMemoryEntry('{{ scope_name }}', '{{ key }}', '{{ value|e }}')" 
                                                style="background: #ffc107; color: #212529; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">‚úèÔ∏è</button>
                                        <button onclick="deleteMemoryEntry('{{ scope_name }}', '{{ key }}')" 
                                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">üóëÔ∏è</button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div style="text-align: center; padding: 1rem; color: #666; font-style: italic;">
                                    No memories in this scope yet
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üí≠</div>
                    <h4>No Memories Available</h4>
                    <p>This student doesn't have any tutor memories yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Progress Tab -->
    <div id="content-progress" class="tab-content">
        <div class="v4-context-section">
            <div class="v4-section-header">
                <div class="v4-section-title">üìä Learning Progress</div>
                <div style="font-size: 0.8rem; color: #666;">Mastery tracking and learning analytics</div>
            </div>
            
            {% if student_context.progress %}
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div style="text-align: center;">
                        <div class="progress-circle" style="--progress: {{ student_context.progress.overall_mastery_percentage or 0 }}%;">
                            <div class="progress-circle-inner">
                                <span class="progress-circle-text">{{ student_context.progress.overall_mastery_percentage or 0 }}%</span>
                            </div>
                        </div>
                        <h4 style="color: #2c3e50; margin: 0;">Overall Mastery</h4>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div class="context-stat">
                            <div class="context-stat-value">{{ student_context.progress.total_goals_tracked or 0 }}</div>
                            <div class="context-stat-label">Goals Tracked</div>
                        </div>
                        <div class="context-stat">
                            <div class="context-stat-value">{{ student_context.progress.completed_goals or 0 }}</div>
                            <div class="context-stat-label">Completed Goals</div>
                        </div>
                        <div class="context-stat">
                            <div class="context-stat-value">{{ student_context.progress.active_subjects or 0 }}</div>
                            <div class="context-stat-label">Active Subjects</div>
                        </div>
                        <div class="context-stat">
                            <div class="context-stat-value">{{ student_context.progress.session_count or 0 }}</div>
                            <div class="context-stat-label">Sessions</div>
                        </div>
                    </div>
                </div>
                
                {% if student_context.progress.recent_achievements %}
                <div style="background: #f0f9f0; border-left: 4px solid #4caf50; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #388e3c; margin: 0 0 0.5rem 0;">üèÜ Recent Achievements</h4>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #2e7d32;">
                        {% for achievement in student_context.progress.recent_achievements %}
                        <li>{{ achievement }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if student_context.progress.areas_for_improvement %}
                <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 1rem; border-radius: 8px;">
                    <h4 style="color: #f57c00; margin: 0 0 0.5rem 0;">üéØ Areas for Improvement</h4>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #ef6c00;">
                        {% for area in student_context.progress.areas_for_improvement %}
                        <li>{{ area }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            {% else %}
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                    <h4>No Progress Data Available</h4>
                    <p>This student's progress tracking will appear here once they start learning.</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Curriculum Atlas Tab -->
    <div id="content-curriculum" class="tab-content">
        <div class="v4-context-section">
            <div class="v4-section-header">
                <div class="v4-section-title">üìö Curriculum Atlas</div>
                <div style="font-size: 0.8rem; color: #666;">Grade-specific curriculum with goals and prerequisites</div>
            </div>
            
            {% if student_context._curriculum and student_context._curriculum.subjects %}
                <div style="margin-bottom: 1.5rem;">
                    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 1rem; border-radius: 8px;">
                        <h4 style="color: #1976d2; margin: 0 0 0.5rem 0;">üìã Curriculum Overview</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; color: #1565c0;">
                            <div><strong>Grade Level:</strong> {{ student_context._curriculum.grade_level or 'N/A' }}</div>
                            <div><strong>Subjects:</strong> {{ student_context._curriculum.subjects|length }}</div>
                            <div><strong>Total Goals:</strong> {{ student_context._curriculum.total_goals or 0 }}</div>
                            <div><strong>Curriculum:</strong> {{ student_context._curriculum.curriculum_name or 'Default' }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="curriculum-atlas-grid">
                    {% for subject_name, subject_data in student_context._curriculum.subjects.items() %}
                    <div class="curriculum-subject-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="color: #2c3e50; margin: 0;">üìñ {{ subject_name }}</h3>
                            <div style="background: #e8f5e8; color: #2d5a3d; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                                {{ subject_data.goals|length }} goals
                            </div>
                        </div>
                        
                        {% if subject_data.description %}
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">{{ subject_data.description }}</p>
                        {% endif %}
                        
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #34495e; margin: 0 0 0.5rem 0; font-size: 1rem;">üéØ Learning Goals</h4>
                            {% for goal in subject_data.goals %}
                            <div class="goal-card">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="font-weight: 600; color: #2c3e50;">{{ goal.goal_code }}</div>
                                    {% if goal.mastery_percentage is defined %}
                                    <div style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">
                                        {{ goal.mastery_percentage }}% mastery
                                    </div>
                                    {% endif %}
                                </div>
                                
                                {% if goal.title %}
                                <div style="color: #555; font-size: 0.9rem; margin-bottom: 0.5rem;">{{ goal.title }}</div>
                                {% endif %}
                                
                                {% if goal.knowledge_components %}
                                <div style="margin-bottom: 0.5rem;">
                                    <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Knowledge Components:</div>
                                    <div>
                                        {% for kc in goal.knowledge_components %}
                                        <span class="kc-badge">{{ kc.kc_code }}: {{ kc.kc_name }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if goal.prerequisites %}
                                <div>
                                    <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Prerequisites:</div>
                                    <div>
                                        {% for prereq in goal.prerequisites %}
                                        <span class="prerequisite-badge">{{ prereq }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üìö</div>
                    <h4>No Curriculum Atlas Available</h4>
                    <p>This student's curriculum atlas will appear here once the data is loaded.</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Raw JSON Tab -->
    <div id="content-raw-json" class="tab-content">
        <div class="v4-context-section">
            <div class="v4-section-header">
                <div class="v4-section-title">üîß Raw JSON Context</div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="copyJsonToClipboard()" style="background: #17a2b8; color: white; font-size: 0.8rem;">
                        üìã Copy JSON
                    </button>
                    <button class="btn" onclick="downloadJsonFile()" style="background: #28a745; color: white; font-size: 0.8rem;">
                        üíæ Download
                    </button>
                    <button class="btn" onclick="refreshJsonView()" style="background: #6c757d; color: white; font-size: 0.8rem;">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            
            <div id="json-container" class="json-viewer">
                <div style="text-align: center; color: #888;">Loading JSON context...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
const studentId = '{{ student_context.demographics.student_id }}';
const studentName = '{{ student_context.demographics.name }}';
let rawJsonData = null;

// Tab functionality
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(`content-${tabName}`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // Load data for specific tabs
    if (tabName === 'raw-json') {
        loadRawJsonView();
    }
}

// JSON viewer functions
function loadRawJsonView() {
    const container = document.getElementById('json-container');
    container.innerHTML = '<div style="text-align: center; color: #888;">Loading JSON context...</div>';
    
    fetch(`/api/v1/student-context/${studentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                rawJsonData = data.data;
                displayJsonData(rawJsonData);
            } else {
                container.innerHTML = `<div style="color: #ff6b6b;">Error: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('Error loading JSON context:', error);
            container.innerHTML = '<div style="color: #ff6b6b;">Failed to load JSON context</div>';
        });
}

function displayJsonData(data) {
    const container = document.getElementById('json-container');
    const formattedJson = JSON.stringify(data, null, 2);
    const highlightedJson = syntaxHighlight(formattedJson);
    container.innerHTML = highlightedJson;
}

function syntaxHighlight(json) {
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'json-number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'json-key';
            } else {
                cls = 'json-string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'json-boolean';
        } else if (/null/.test(match)) {
            cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}

function copyJsonToClipboard() {
    if (!rawJsonData) {
        alert('No JSON data available to copy');
        return;
    }
    
    const jsonString = JSON.stringify(rawJsonData, null, 2);
    navigator.clipboard.writeText(jsonString).then(() => {
        alert('JSON copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy JSON:', err);
        alert('Failed to copy JSON to clipboard');
    });
}

function downloadJsonFile() {
    if (!rawJsonData) {
        alert('No JSON data available to download');
        return;
    }
    
    const jsonString = JSON.stringify(rawJsonData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `student_${studentId}_context_v4.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function refreshJsonView() {
    loadRawJsonView();
}

// Memory management functions
function addMemoryEntry(scope = null) {
    const key = prompt(`Enter memory key for ${scope || 'memory'}:`);
    if (!key) return;
    
    const value = prompt(`Enter memory value for "${key}":`);
    if (!value) return;
    
    updateMemory(scope, key, value);
}

function editMemoryEntry(scope, key, currentValue) {
    const value = prompt(`Edit memory value for "${key}":`, currentValue);
    if (value === null) return;
    
    updateMemory(scope, key, value);
}

function deleteMemoryEntry(scope, key) {
    if (!confirm(`Are you sure you want to delete the memory "${key}" from ${scope}?`)) {
        return;
    }
    
    updateMemory(scope, key, null);
}

function updateMemory(scope, key, value) {
    const updateData = {
        memory: {
            [scope]: {
                [key]: value
            }
        }
    };
    
    fetch(`/api/v1/students/${studentId}/memory`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' || data.status === 'partial') {
            location.reload(); // Refresh the page to show changes
        } else {
            alert(`Error updating memory: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error updating memory:', error);
        alert('Failed to update memory');
    });
}

// Student management functions
function deleteStudent(studentId, studentName) {
    if (!confirm(`Are you sure you want to delete student "${studentName}"?\n\nThis action will permanently delete all data associated with this student and cannot be undone.`)) {
        return;
    }
    
    fetch(`/admin/students/${studentId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            window.location.href = data.redirect;
        } else {
            alert(`‚ùå Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Delete request failed:', error);
        alert(`‚ùå Failed to delete student: ${error.message}`);
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set initial JSON data if available
    try {
        const contextData = '{{ student_context|tojson|safe }}';
        rawJsonData = JSON.parse(contextData);
    } catch (e) {
        console.warn('Could not parse initial JSON data:', e);
        rawJsonData = null;
    }
});
</script>
</script>
{% endblock %}