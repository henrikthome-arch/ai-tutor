{% extends "base.html" %}

{% block title %}Database Browser - AI Tutor Admin{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('main.admin_dashboard') }}">üìä Dashboard</a> &gt;
    <span>üóÑÔ∏è Database Browser</span>
</div>

<h1 style="margin-bottom: 2rem; color: #2c3e50;">Database Browser</h1>

<div class="card">
    <h2>üìä Database Overview</h2>
    <p>Browse and explore the PostgreSQL database tables and their contents.</p>
    
    {% if stats %}
    <div class="stats-grid" style="margin: 1.5rem 0;">
        <div class="stat-card">
            <h3>{{ stats.students }}</h3>
            <p>Students</p>
        </div>
        <div class="stat-card">
            <h3>{{ stats.schools }}</h3>
            <p>Schools</p>
        </div>
        <div class="stat-card">
            <h3>{{ stats.curriculums }}</h3>
            <p>Curriculums</p>
        </div>
        <div class="stat-card">
            <h3>{{ stats.sessions }}</h3>
            <p>Sessions</p>
        </div>
        <div class="stat-card">
            <h3>{{ stats.assessments }}</h3>
            <p>Assessments</p>
        </div>
    </div>
    {% endif %}
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>üóÇÔ∏è Database Tables</h2>
        <button id="copyAllTablesBtn" class="btn" style="background: #3498db; color: white; font-size: 0.9rem; padding: 6px 12px;">
            üìã Copy All as Markdown
        </button>
    </div>
    
    {% if tables %}
    <table class="table">
        <thead>
            <tr>
                <th>Table Name</th>
                <th>Record Count</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for table in tables %}
            <tr>
                <td>
                    <strong>{{ table.name }}</strong>
                </td>
                <td>
                    <span style="background: #e3f2fd; padding: 4px 8px; border-radius: 12px; font-size: 0.9rem;">
                        {{ table.count }} records
                    </span>
                </td>
                <td>
                    <a href="{{ table.url }}" class="btn" style="font-size: 0.9rem; padding: 6px 12px;">
                        üëÅÔ∏è Browse
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 2rem; color: #666;">
        <p>‚ùå No database tables found or error accessing database.</p>
        <p style="font-size: 0.9rem; margin-top: 1rem;">
            Please check your database connection and configuration.
        </p>
    </div>
    {% endif %}
</div>

<div class="card">
    <h2>‚ÑπÔ∏è Database Information</h2>
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
        <p><strong>Database Type:</strong> PostgreSQL</p>
        <p><strong>Connection Status:</strong> 
            {% if tables %}
                <span style="color: #27ae60;">‚úì Connected</span>
            {% else %}
                <span style="color: #e74c3c;">‚ùå Connection Error</span>
            {% endif %}
        </p>
        <p><strong>Last Updated:</strong> {{ moment().format('YYYY-MM-DD HH:mm:ss') if moment else 'Unknown' }}</p>
    </div>
    
    <div style="margin-top: 1rem;">
        <a href="{{ url_for('main.admin_system') }}" class="btn">
            ‚öôÔ∏è System Settings
        </a>
        <a href="{{ url_for('main.admin_system_logs') }}" class="btn" style="margin-left: 10px;">
            üìã View Logs
        </a>
    </div>
</div>

<div class="card" style="border-left: 4px solid #e74c3c;">
    <h2 style="color: #e74c3c;">‚ö†Ô∏è Dangerous Operations</h2>
    <div style="background: #fff5f5; padding: 1rem; border-radius: 4px; border: 1px solid #fecaca;">
        <p><strong>‚ö†Ô∏è WARNING:</strong> The following operations are irreversible and will affect all data in the database.</p>
        <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #666;">
            Only use these operations if you understand the consequences and have verified there is no important data to preserve.
        </p>
    </div>
    
    <div style="margin-top: 1.5rem;">
        <button id="resetDatabaseBtn" class="btn" style="background: #e74c3c; color: white; font-weight: bold;">
            üîÑ Reset Database
        </button>
        <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
            This will drop all tables, recreate fresh schema, and reload Cambridge curriculum data.
        </p>
    </div>
</div>

<!-- Database Reset Confirmation Modal -->
<div id="resetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 style="color: #e74c3c; margin-top: 0;">‚ö†Ô∏è Confirm Database Reset</h3>
        <p style="margin: 1rem 0;">
            <strong>This action will:</strong>
        </p>
        <ul style="margin: 1rem 0; padding-left: 1.5rem; color: #666;">
            <li>Drop ALL existing database tables</li>
            <li>Delete ALL student, session, and curriculum data</li>
            <li>Create fresh database tables with updated schema</li>
            <li>Reload Cambridge Primary 2025 curriculum data</li>
        </ul>
        <p style="color: #e74c3c; font-weight: bold;">
            This operation cannot be undone!
        </p>
        
        <div style="margin-top: 1.5rem;">
            <label style="display: block; margin-bottom: 1rem;">
                <input type="checkbox" id="confirmCheckbox" style="margin-right: 0.5rem;">
                I understand this will delete all data and cannot be undone
            </label>
        </div>
        
        <div style="text-align: right; margin-top: 1.5rem;">
            <button id="cancelResetBtn" class="btn" style="margin-right: 1rem;">
                Cancel
            </button>
            <button id="confirmResetBtn" class="btn" style="background: #e74c3c; color: white;" disabled>
                Reset Database
            </button>
        </div>
        
        <div id="resetProgress" style="display: none; margin-top: 1rem; text-align: center;">
            <p>üîÑ Resetting database...</p>
            <div style="background: #f0f0f0; height: 4px; border-radius: 2px; overflow: hidden;">
                <div style="background: #3498db; height: 100%; width: 0%; transition: width 0.3s; animation: progress 2s infinite;"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const resetBtn = document.getElementById('resetDatabaseBtn');
    const modal = document.getElementById('resetModal');
    const cancelBtn = document.getElementById('cancelResetBtn');
    const confirmBtn = document.getElementById('confirmResetBtn');
    const checkbox = document.getElementById('confirmCheckbox');
    const progress = document.getElementById('resetProgress');
    
    // Show modal when reset button is clicked
    resetBtn.addEventListener('click', function() {
        modal.style.display = 'block';
        checkbox.checked = false;
        confirmBtn.disabled = true;
    });
    
    // Hide modal when cancel is clicked
    cancelBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });
    
    // Hide modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // Enable/disable confirm button based on checkbox
    checkbox.addEventListener('change', function() {
        confirmBtn.disabled = !checkbox.checked;
    });
    
    // Handle database reset confirmation
    confirmBtn.addEventListener('click', function() {
        if (!checkbox.checked) return;
        
        // Show progress
        progress.style.display = 'block';
        confirmBtn.disabled = true;
        cancelBtn.disabled = true;
        
        // Create form data
        const formData = new FormData();
        formData.append('confirm', 'true');
        
        // Send reset request
        fetch('{{ url_for("main.admin_database_reset") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            progress.style.display = 'none';
            modal.style.display = 'none';
            
            if (data.success) {
                alert('‚úÖ Database reset completed successfully!\n\n' +
                      'Tables dropped: ' + (data.results.tables_dropped ? 'Yes' : 'No') + '\n' +
                      'Tables created: ' + (data.results.tables_created ? 'Yes' : 'No') + '\n' +
                      'Curriculum loaded: ' + (data.results.curriculum_loaded ? 'Yes' : 'No') + '\n' +
                      (data.results.curriculum_details ? 'Curriculum details: ' + data.results.curriculum_details + '\n' : '') +
                      (data.results.total_subjects ? 'Total subjects: ' + data.results.total_subjects : ''));
                
                // Reload the page to show updated data
                window.location.reload();
            } else {
                alert('‚ùå Database reset failed:\n\n' + data.error);
            }
        })
        .catch(error => {
            progress.style.display = 'none';
            modal.style.display = 'none';
            alert('‚ùå Network error during database reset:\n\n' + error.message);
        })
        .finally(() => {
            confirmBtn.disabled = false;
            cancelBtn.disabled = false;
        });
    });
    // Copy all tables functionality
    const copyAllBtn = document.getElementById('copyAllTablesBtn');
    const copyAllToast = document.getElementById('copyAllToast');

    if (copyAllBtn) {
        copyAllBtn.addEventListener('click', function() {
            copyAllTablesAsMarkdown();
        });
    }

    function copyAllTablesAsMarkdown() {
        // Build markdown for entire database structure
        let markdown = `# Database Structure Overview\n\n`;
        markdown += `**Database Type:** PostgreSQL\n`;
        markdown += `**Last Updated:** ${new Date().toLocaleString()}\n\n`;
        
        // Add overview table
        const tableRows = document.querySelectorAll('.table tbody tr');
        if (tableRows.length > 0) {
            markdown += `## Tables Summary\n\n`;
            markdown += `| Table Name | Record Count | Actions |\n`;
            markdown += `| --- | --- | --- |\n`;
            
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    const tableName = cells[0].textContent.trim();
                    const recordCount = cells[1].textContent.trim();
                    const browseUrl = cells[2].querySelector('a') ? cells[2].querySelector('a').href : 'N/A';
                    markdown += `| ${tableName} | ${recordCount} | [Browse](${browseUrl}) |\n`;
                }
            });
            
            markdown += `\n`;
            markdown += `## Individual Table Details\n\n`;
            markdown += `*Note: Click on individual table "Browse" links and use the "Copy as Markdown" button on each table page to get detailed table contents.*\n\n`;
            
            // Add table details section
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    const tableName = cells[0].textContent.trim();
                    const recordCount = cells[1].textContent.trim();
                    markdown += `### ${tableName}\n`;
                    markdown += `- **Records:** ${recordCount}\n`;
                    markdown += `- **Purpose:** *Database table for ${tableName.toLowerCase().replace(/_/g, ' ')}*\n\n`;
                }
            });
        } else {
            markdown += `*No tables found in database.*\n`;
        }
        
        // Copy to clipboard
        navigator.clipboard.writeText(markdown).then(function() {
            showCopyAllToast();
        }).catch(function(err) {
            console.error('Failed to copy text: ', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = markdown;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showCopyAllToast();
        });
    }

    function showCopyAllToast() {
        if (copyAllToast) {
            copyAllToast.style.display = 'block';
            setTimeout(function() {
                copyAllToast.style.display = 'none';
            }, 3000);
        }
    }
});
</script>

<!-- Copy All Status Toast -->
<div id="copyAllToast" style="display: none; position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 1rem 1.5rem; border-radius: 4px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    ‚úÖ Database structure copied to clipboard as markdown!
</div>

<style>
@keyframes progress {
    0% { width: 0%; }
    50% { width: 100%; }
    100% { width: 0%; }
}
</style>

{% endblock %}