{% extends "base.html" %}

{% block title %}System - AI Tutor Admin{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('admin_dashboard') }}">📊 Dashboard</a> / <span>⚙️ System</span>
</div>

<h1 style="margin-bottom: 2rem; color: #2c3e50;">System Settings & Monitoring</h1>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
    <div class="card">
        <h2>📱 Phone Number Mappings</h2>
        <p style="color: #666; margin-bottom: 1rem;">Manage phone number to student ID mappings for automated identification during calls.</p>
        
        {% if phone_mappings %}
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>📱 Phone Number</th>
                            <th>👤 Student</th>
                            <th>⚡ Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for phone, student_id in phone_mappings.items() %}
                        <tr>
                            <td style="font-family: monospace;">{{ phone }}</td>
                            <td>
                                {% if students_info[student_id] %}
                                    <a href="{{ url_for('admin_student_detail', student_id=student_id) }}" 
                                       style="color: #3498db; text-decoration: none;">
                                       {{ students_info[student_id].name }}
                                    </a>
                                    <br>
                                    <span style="color: #666; font-size: 0.9rem;">ID: {{ student_id }}</span>
                                {% else %}
                                    <span style="color: #e74c3c;">⚠ Student not found</span>
                                    <br>
                                    <span style="color: #666; font-size: 0.9rem;">ID: {{ student_id }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-danger"
                                        style="padding: 4px 8px; font-size: 0.8rem;"
                                        onclick="removePhoneMapping('{{ phone }}')">
                                    🗑️ Remove
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div style="text-align: center; padding: 2rem; color: #666; background: #f8f9fa; border-radius: 4px;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">📱</div>
                <h4>No Phone Mappings</h4>
                <p>No phone numbers are currently mapped to students.</p>
            </div>
        {% endif %}
        
        <div style="margin-top: 1rem; text-align: center;">
            <button class="btn btn-success" onclick="addPhoneMapping()">
                ➕ Add Phone Mapping
            </button>
        </div>
    </div>
    
    <div class="card">
        <h2>📊 System Statistics</h2>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <span style="font-weight: 600;">Total Students:</span>
                <span style="color: #3498db; font-weight: bold;">{{ system_stats.total_students }}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <span style="font-weight: 600;">Total Sessions:</span>
                <span style="color: #27ae60; font-weight: bold;">{{ system_stats.total_sessions }}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <span style="font-weight: 600;">Phone Mappings:</span>
                <span style="color: #e67e22; font-weight: bold;">{{ system_stats.phone_mappings }}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <span style="font-weight: 600;">Data Directory Size:</span>
                <span style="color: #9b59b6; font-weight: bold;">{{ system_stats.data_size }}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <span style="font-weight: 600;">Last Backup:</span>
                <span style="color: #666; font-weight: bold;">{{ system_stats.last_backup or 'Never' }}</span>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h2>🔧 System Health</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="padding: 1rem; border: 2px solid #27ae60; border-radius: 4px; background: #f0f9f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;">MCP Server</span>
                <span style="color: #27ae60; font-size: 1.2rem;">✅</span>
            </div>
            <p style="color: #666; font-size: 0.9rem; margin: 0;">Running on port {{ mcp_port or '3001' }}</p>
        </div>
        
        <div style="padding: 1rem; border: 2px solid #27ae60; border-radius: 4px; background: #f0f9f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;">Admin Dashboard</span>
                <span style="color: #27ae60; font-size: 1.2rem;">✅</span>
            </div>
            <p style="color: #666; font-size: 0.9rem; margin: 0;">Online and responsive</p>
        </div>
        
        <div style="padding: 1rem; border: 2px solid
            {% if system_stats.database and system_stats.database.connection_status == 'connected' %}#27ae60
            {% elif system_stats.database and system_stats.database.connection_status == 'error' %}#e74c3c
            {% else %}#f39c12{% endif %};
            border-radius: 4px; background:
            {% if system_stats.database and system_stats.database.connection_status == 'connected' %}#f0f9f0
            {% elif system_stats.database and system_stats.database.connection_status == 'error' %}#fef5f5
            {% else %}#fef9e7{% endif %};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;">PostgreSQL Database</span>
                <span style="color:
                    {% if system_stats.database and system_stats.database.connection_status == 'connected' %}#27ae60
                    {% elif system_stats.database and system_stats.database.connection_status == 'error' %}#e74c3c
                    {% else %}#f39c12{% endif %};
                    font-size: 1.2rem;">
                    {% if system_stats.database and system_stats.database.connection_status == 'connected' %}✅
                    {% elif system_stats.database and system_stats.database.connection_status == 'error' %}❌
                    {% else %}⚠️{% endif %}
                </span>
            </div>
            <p style="color: #666; font-size: 0.9rem; margin: 0;">
                {% if system_stats.database and system_stats.database.connection_status == 'connected' %}
                    Connected and operational
                {% elif system_stats.database and system_stats.database.connection_status == 'error' %}
                    Connection error: {{ system_stats.database.error }}
                {% else %}
                    Status unknown
                {% endif %}
            </p>
        </div>
        
        <div style="padding: 1rem; border: 2px solid {% if vapi_status %}#27ae60{% else %}#f39c12{% endif %}; border-radius: 4px; background: {% if vapi_status %}#f0f9f0{% else %}#fef9e7{% endif %};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;">VAPI Integration</span>
                <span style="color: {% if vapi_status %}#27ae60{% else %}#f39c12{% endif %}; font-size: 1.2rem;">
                    {% if vapi_status %}✅{% else %}⚠️{% endif %}
                </span>
            </div>
            <p style="color: #666; font-size: 0.9rem; margin: 0;">
                {% if vapi_status %}Connected and ready{% else %}Not configured{% endif %}
            </p>
        </div>
    </div>
</div>

{% if vapi_test_enabled %}
<!-- VAPI Webhook Testing Section -->
{% include 'vapi_test_section.html' %}
{% endif %}

{% if environmental_issues %}
<div class="card" style="margin-top: 2rem;">
    <h2>🚨 Environmental Issues</h2>
    <p style="color: #666; margin-bottom: 1rem;">The following issues were detected in your environment configuration. Please fix them to ensure proper operation.</p>
    
    <div style="display: flex; flex-direction: column; gap: 1rem;">
        {% for issue in environmental_issues %}
        <div style="padding: 1rem; border: 2px solid
            {% if issue.severity == 'critical' %}#e74c3c
            {% elif issue.severity == 'high' %}#e67e22
            {% elif issue.severity == 'medium' %}#f39c12
            {% else %}#3498db{% endif %};
            border-radius: 4px; background:
            {% if issue.severity == 'critical' %}#fef5f5
            {% elif issue.severity == 'high' %}#fef6ee
            {% elif issue.severity == 'medium' %}#fef9e7
            {% else %}#eef7fb{% endif %};">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;">{{ issue.title }}</span>
                <span style="
                    {% if issue.severity == 'critical' %}color: #e74c3c;
                    {% elif issue.severity == 'high' %}color: #e67e22;
                    {% elif issue.severity == 'medium' %}color: #f39c12;
                    {% else %}color: #3498db;{% endif %}
                    font-size: 1rem; font-weight: bold;">
                    {% if issue.severity == 'critical' %}🚨 CRITICAL
                    {% elif issue.severity == 'high' %}⚠️ HIGH
                    {% elif issue.severity == 'medium' %}⚠️ MEDIUM
                    {% else %}ℹ️ LOW{% endif %}
                </span>
            </div>
            
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">{{ issue.description }}</p>
            
            <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>How to fix:</strong> {{ issue.fix }}
            </div>
            
            {% if issue.docs_link %}
            <div style="text-align: right;">
                <a href="{{ issue.docs_link }}" target="_blank" style="color: #3498db; text-decoration: none;">
                    📄 View Documentation
                </a>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
    <div class="card">
        <h2>📁 Data Management</h2>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="{{ url_for('admin_system_logs') }}" class="btn" style="background: #17a2b8;">
                📋 View System Logs
            </a>
            
            <a href="{{ url_for('admin_database') }}" class="btn" style="background: #3498db;">
                📂 Browse Database
            </a>
            
            <a href="{{ url_for('health_check') }}" target="_blank" class="btn" style="background: #27ae60;">
                🔍 View Detailed Health Check
            </a>
        </div>
    </div>
    
    <div class="card">
        <h2>⚙️ Configuration</h2>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                <p style="color: #666; margin: 0;">
                    <strong>Environment:</strong> {{ system_stats.environment or 'Unknown' }}
                </p>
            </div>
            
            <div style="padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                <p style="color: #666; margin: 0;">
                    <strong>Database Type:</strong>
                    {% if system_stats.database and system_stats.database.type %}
                        {{ system_stats.database.type }}
                    {% else %}
                        Unknown
                    {% endif %}
                </p>
            </div>
            
            <div style="padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                <p style="color: #666; margin: 0;">
                    <strong>Server Time:</strong> {{ system_stats.timestamp or 'Unknown' }}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 2rem;">
    <h2>📋 Recent System Events</h2>
    {% if system_events %}
        <div style="max-height: 300px; overflow-y: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>🕐 Time</th>
                        <th>📌 Event</th>
                        <th>👤 User</th>
                        <th>📊 Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in system_events %}
                    <tr>
                        <td style="font-family: monospace; font-size: 0.9rem;">{{ event.timestamp }}</td>
                        <td>{{ event.message }}</td>
                        <td>{{ event.user or 'System' }}</td>
                        <td>
                            <span style="color: {% if event.status == 'success' %}#27ae60{% elif event.status == 'warning' %}#f39c12{% else %}#e74c3c{% endif %};">
                                {% if event.status == 'success' %}✅{% elif event.status == 'warning' %}⚠️{% else %}❌{% endif %}
                                {{ event.status.title() }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 2rem; color: #666;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">📋</div>
            <h4>No Recent Events</h4>
            <p>No system events have been logged recently.</p>
        </div>
    {% endif %}
</div>

<script>
async function removePhoneMapping(phoneNumber) {
    if (!confirm(`Are you sure you want to remove the phone mapping for ${phoneNumber}?`)) {
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('phone_number', phoneNumber);
        
        const response = await fetch('/admin/phone-mappings/remove', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            location.reload(); // Refresh the page to show changes
        } else {
            const error = await response.json();
            alert(`Error: ${error.error || 'Failed to remove phone mapping'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function addPhoneMapping() {
    const phoneNumber = prompt('Enter phone number (e.g., +30-123-456-7890):');
    if (!phoneNumber) return;
    
    const studentId = prompt('Enter student ID:');
    if (!studentId) return;
    
    try {
        const formData = new FormData();
        formData.append('phone_number', phoneNumber);
        formData.append('student_id', studentId);
        
        const response = await fetch('/admin/phone-mappings/add', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            location.reload(); // Refresh the page to show changes
        } else {
            const error = await response.json();
            alert(`Error: ${error.error || 'Failed to add phone mapping'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}
</script>
{% endblock %}