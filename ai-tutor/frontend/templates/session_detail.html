{% extends "base.html" %}

{% block title %}Session Details - AI Tutor Admin{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('main.admin_dashboard') }}">📊 Dashboard</a> /
    <a href="{{ url_for('main.admin_students') }}">👥 Students</a> /
    <a href="{{ url_for('main.admin_student_detail', student_id=student_id) }}">Student</a> /
    <a href="{{ url_for('main.view_student_sessions', student_id=student_id) }}">🕒 Sessions</a> /
    <span>📄 {{ session_file }}</span>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="color: #2c3e50;">Session Details</h1>
    <div style="display: flex; gap: 1rem;">
        <button class="btn" onclick="copyAllSessionData()" style="background: #e74c3c; color: white;">
            📋 Copy All Data
        </button>
        <a href="{{ url_for('main.view_student_sessions', student_id=student_id) }}" class="btn" style="background: #95a5a6;">
            ← Back to Sessions
        </a>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem; margin-bottom: 2rem;">
    <div class="card">
        <h2>📊 Session Information</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <label style="font-weight: 600; color: #666;">Session File</label>
                <p style="margin: 5px 0 15px 0; font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                    {{ session_file }}
                </p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Session Type</label>
                <p style="margin: 5px 0 15px 0;">
                    <span style="background: {% if 'vapi' in session_file %}#e3f2fd{% else %}#f3e5f5{% endif %}; 
                                 color: {% if 'vapi' in session_file %}#1976d2{% else %}#7b1fa2{% endif %}; 
                                 padding: 6px 12px; border-radius: 12px;">
                        {% if 'vapi' in session_file %}📞 VAPI Call{% else %}📚 Regular Session{% endif %}
                    </span>
                </p>
            </div>
            
            {% if session_data.start_time %}
            <div>
                <label style="font-weight: 600; color: #666;">Start Time</label>
                <p style="margin: 5px 0 15px 0;">{{ session_data.start_time.split('T')[0] }} {{ session_data.start_time.split('T')[1][:8] if 'T' in session_data.start_time else '' }}</p>
            </div>
            {% endif %}
            
            {% if session_data.duration_seconds or session_data.duration_minutes %}
            <div>
                <label style="font-weight: 600; color: #666;">Duration</label>
                <p style="margin: 5px 0 15px 0;">
                    {% if session_data.duration_minutes %}
                        {{ session_data.duration_minutes }} minutes
                    {% elif session_data.duration_seconds %}
                        {{ session_data.duration_seconds // 60 }} minutes
                    {% endif %}
                </p>
            </div>
            {% endif %}
            
            {% if session_data.call_id %}
            <div style="grid-column: 1 / -1;">
                <label style="font-weight: 600; color: #666;">VAPI Call ID</label>
                <p style="margin: 5px 0 15px 0; font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                    {{ session_data.call_id }}
                </p>
            </div>
            {% endif %}
            
            {% if session_data.phone_number %}
            <div>
                <label style="font-weight: 600; color: #666;">Phone Number</label>
                <p style="margin: 5px 0 15px 0;">📱 {{ session_data.phone_number }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div class="card">
            <h3 style="margin-bottom: 1rem;">📋 Quick Actions</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                {% if session_data.summary %}
                <button class="btn" onclick="scrollToSummary()" style="background: #16a085;">
                    📋 View Summary
                </button>
                {% endif %}
                
                {% if transcript %}
                <button class="btn" onclick="scrollToTranscript()" style="background: #3498db;">
                    📄 View Transcript
                </button>
                {% endif %}
                
                {% if analysis %}
                <button class="btn" onclick="scrollToAnalysis()" style="background: #e67e22;">
                    🤖 View AI Analysis
                </button>
                {% endif %}
                
                {% if session_data.ai_processing_steps %}
                <button class="btn" onclick="scrollToAiProcessing()" style="background: #9c27b0;">
                    🧠 View AI Processing
                </button>
                {% endif %}
                
                <button class="btn" onclick="downloadSessionData()" style="background: #27ae60;">
                    📥 Download Data
                </button>
            </div>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom: 1rem;">📊 Data Summary</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Has Transcript:</span>
                    <strong style="color: {% if session_data.has_transcript_display %}#27ae60{% else %}#e74c3c{% endif %};">
                        {% if session_data.has_transcript_display %}✅ Yes{% else %}❌ No{% endif %}
                    </strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Summary:</span>
                    <strong style="color: {% if session_data.summary %}#27ae60{% else %}#e74c3c{% endif %};">
                        {% if session_data.summary %}✅ Available{% else %}❌ Missing{% endif %}
                    </strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>AI Analysis:</span>
                    <strong style="color: {% if session_data.has_analysis_display %}#27ae60{% else %}#e74c3c{% endif %};">
                        {% if session_data.has_analysis_display %}✅ Complete{% else %}❌ Missing{% endif %}
                    </strong>
                </div>
                {% if transcript %}
                <div style="display: flex; justify-content: space-between;">
                    <span>Transcript Size:</span>
                    <strong>{{ transcript|length }} chars</strong>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if session_data.summary %}
<div class="card" id="summary-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>📋 Summary</h2>
        <button class="btn" onclick="copySummary()" style="background: #16a085;">
            📋 Copy Summary
        </button>
    </div>
    <div style="background: #f0f9f6; padding: 1.5rem; border-radius: 4px; border-left: 4px solid #16a085;">
        <pre id="summary-content" style="white-space: pre-wrap; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #2c3e50;">{{ session_data.summary }}</pre>
    </div>
</div>
{% endif %}

{% if transcript %}
<div class="card" id="transcript-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>📄 Session Transcript</h2>
        <button class="btn" onclick="copyTranscript()" style="background: #9b59b6;">
            📋 Copy Transcript
        </button>
    </div>
    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 4px; border-left: 4px solid #3498db;">
        <pre id="transcript-content" style="white-space: pre-wrap; margin: 0; font-family: 'Courier New', monospace; line-height: 1.6;">{{ transcript }}</pre>
    </div>
</div>
{% endif %}

{% if analysis %}
<div class="card" id="analysis-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>🤖 AI Analysis Results</h2>
        <button class="btn" onclick="copyAnalysis()" style="background: #e67e22;">
            📋 Copy Analysis
        </button>
    </div>
    
    {% if analysis.learning_assessment %}
    <div style="margin-bottom: 1.5rem;">
        <h3 style="color: #2c3e50; margin-bottom: 1rem;">📚 Learning Assessment</h3>
        <div style="background: #f0f9f0; padding: 1rem; border-radius: 4px; border-left: 4px solid #27ae60;">
            <pre style="white-space: pre-wrap; margin: 0; line-height: 1.6;">{{ analysis.learning_assessment }}</pre>
        </div>
    </div>
    {% endif %}
    
    {% if analysis.engagement_analysis %}
    <div style="margin-bottom: 1.5rem;">
        <h3 style="color: #2c3e50; margin-bottom: 1rem;">🎯 Engagement Analysis</h3>
        <div style="background: #f9f0ff; padding: 1rem; border-radius: 4px; border-left: 4px solid #9b59b6;">
            <pre style="white-space: pre-wrap; margin: 0; line-height: 1.6;">{{ analysis.engagement_analysis }}</pre>
        </div>
    </div>
    {% endif %}
    
    {% if analysis.recommendations %}
    <div style="margin-bottom: 1.5rem;">
        <h3 style="color: #2c3e50; margin-bottom: 1rem;">💡 Recommendations</h3>
        <div style="background: #fff9f0; padding: 1rem; border-radius: 4px; border-left: 4px solid #f39c12;">
            <pre style="white-space: pre-wrap; margin: 0; line-height: 1.6;">{{ analysis.recommendations }}</pre>
        </div>
    </div>
    {% endif %}
    
    {% if analysis.session_summary %}
    <div style="margin-bottom: 1.5rem;">
        <h3 style="color: #2c3e50; margin-bottom: 1rem;">📋 Session Summary</h3>
        <div style="background: #f0f8ff; padding: 1rem; border-radius: 4px; border-left: 4px solid #3498db;">
            <pre style="white-space: pre-wrap; margin: 0; line-height: 1.6;">{{ analysis.session_summary }}</pre>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

{% if session_data.ai_processing_steps %}
<div class="card" id="ai-processing-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>🧠 AI Processing Steps</h2>
        <button class="btn" onclick="copyAiProcessing()" style="background: #9c27b0;">
            📋 Copy AI Processing
        </button>
    </div>
    
    {% for step in session_data.ai_processing_steps %}
    <div style="margin-bottom: 2rem; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
        <div style="background: #f5f5f5; padding: 1rem; border-bottom: 1px solid #e0e0e0;">
            <h3 style="margin: 0; color: #2c3e50;">Step {{ step.step }}: AI Processing</h3>
            {% if session_data.processing_metadata and session_data.processing_metadata['step_' + step.step|string] %}
            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                {% set metadata = session_data.processing_metadata['step_' + step.step|string] %}
                <span>Provider: <strong>{{ metadata.provider }}</strong></span> |
                <span>Type: <strong>{{ metadata.prompt_type }}</strong></span> |
                <span>Call Type: <strong>{{ metadata.call_type }}</strong></span>
            </div>
            {% endif %}
        </div>
        
        {% if step.has_prompt %}
        <div style="padding: 1rem; border-bottom: 1px solid #f0f0f0;">
            <h4 style="margin: 0 0 0.5rem 0; color: #e67e22;">📤 Prompt Sent to AI:</h4>
            <div style="background: #fff3e0; padding: 1rem; border-radius: 4px; border-left: 4px solid #e67e22;">
                <pre style="white-space: pre-wrap; margin: 0; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.4; max-height: 300px; overflow-y: auto;">{{ step.prompt }}</pre>
            </div>
        </div>
        {% endif %}
        
        {% if step.has_response %}
        <div style="padding: 1rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: #27ae60;">📥 AI Response:</h4>
            <div style="background: #e8f5e8; padding: 1rem; border-radius: 4px; border-left: 4px solid #27ae60;">
                <pre style="white-space: pre-wrap; margin: 0; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.4; max-height: 300px; overflow-y: auto;">{{ step.response }}</pre>
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="card">
    <h2>🔧 Raw Session Data</h2>
    <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; font-weight: 600; padding: 8px 0;">
            📊 Show Raw JSON Data
        </summary>
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
            <pre style="white-space: pre-wrap; margin: 0; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.4;">{{ session_data | tojson(indent=2) }}</pre>
        </div>
    </details>
</div>

<script>
// Create session data for JavaScript use
const sessionDataForJS = {{ session_data | tojson | safe }};

function scrollToSummary() {
    document.getElementById('summary-section').scrollIntoView({ behavior: 'smooth' });
}

function scrollToTranscript() {
    document.getElementById('transcript-section').scrollIntoView({ behavior: 'smooth' });
}

function scrollToAnalysis() {
    document.getElementById('analysis-section').scrollIntoView({ behavior: 'smooth' });
}

function scrollToAiProcessing() {
    document.getElementById('ai-processing-section').scrollIntoView({ behavior: 'smooth' });
}

function copyAiProcessing() {
    const aiProcessingSection = document.getElementById('ai-processing-section');
    const content = aiProcessingSection.textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('AI Processing steps copied to clipboard!');
    });
}

function copyAllSessionData() {
    // Collect all visible content from the page
    let allData = '';
    
    // Get session info
    const sessionInfo = document.querySelector('.card h2').textContent.includes('Session Information') ?
        document.querySelector('.card').textContent.trim() : '';
    if (sessionInfo) {
        allData += '=== SESSION DETAILS ===\n' + sessionInfo + '\n\n';
    }
    
    // Get summary
    const summaryElement = document.getElementById('summary-content');
    if (summaryElement) {
        allData += '=== SUMMARY ===\n' + summaryElement.textContent + '\n\n';
    }
    
    // Get transcript
    const transcriptElement = document.getElementById('transcript-content');
    if (transcriptElement) {
        allData += '=== TRANSCRIPT ===\n' + transcriptElement.textContent + '\n\n';
    }
    
    // Get analysis
    const analysisElement = document.getElementById('analysis-section');
    if (analysisElement) {
        allData += '=== AI ANALYSIS ===\n' + analysisElement.textContent + '\n\n';
    }
    
    // Get AI processing steps
    const aiProcessingElement = document.getElementById('ai-processing-section');
    if (aiProcessingElement) {
        allData += '=== AI PROCESSING STEPS ===\n' + aiProcessingElement.textContent + '\n\n';
    }
    
    // Get raw data
    allData += '=== RAW SESSION DATA ===\n' + JSON.stringify(sessionDataForJS, null, 2);
    
    // Copy to clipboard
    navigator.clipboard.writeText(allData).then(() => {
        alert('All session data copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy data: ', err);
        alert('Failed to copy data to clipboard');
    });
}

function copySummary() {
    const content = document.getElementById('summary-content').textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('Summary copied to clipboard!');
    });
}

function copyTranscript() {
    const content = document.getElementById('transcript-content').textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('Transcript copied to clipboard!');
    });
}

function copyAnalysis() {
    const analysisSection = document.getElementById('analysis-section');
    const content = analysisSection.textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('Analysis copied to clipboard!');
    });
}

function downloadSessionData() {
    const blob = new Blob([JSON.stringify(sessionDataForJS, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ session_file }}';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}