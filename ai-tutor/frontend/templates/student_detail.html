{% extends "base.html" %}

{% block title %}{{ student.name }} - AI Tutor Admin{% endblock %}

{% block styles %}
<style>
    .progress-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: conic-gradient(#27ae60 var(--progress, 0%), #ecf0f1 0);
        margin: 0 auto 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .progress-circle-inner {
        width: 70px;
        height: 70px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .progress-circle-text {
        font-size: 1.2rem;
        font-weight: bold;
        color: #27ae60;
    }
    .grid-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    .progress-list, .goal-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .progress-item .progress-title {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    .progress-item .subject-name {
        font-weight: 600;
    }
    .progress-item .progress-percentage {
        color: #666;
    }
    .progress-bar-container {
        width: 100%;
        height: 8px;
        background: #ecf0f1;
        border-radius: 4px;
        overflow: hidden;
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #8e44ad);
        transition: width 0.3s ease;
    }
    .last-studied {
        margin-top: 5px;
        font-size: 0.9rem;
        color: #666;
    }
    .goal-item {
        padding: 12px;
        border-left-width: 4px;
        border-left-style: solid;
    }
    .goal-item.completed {
        border-left-color: #27ae60;
        background: #f0f9f0;
    }
    .goal-item.pending {
        border-left-color: #3498db;
        background: #f8f9fa;
    }
    .goal-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
    }
    .goal-title .completed {
        color: #27ae60;
    }
    .goal-title .pending {
        color: #3498db;
    }
    .goal-description {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 0.9rem;
    }
    .goal-target-date {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 0.8rem;
    }
   .engagement-score.score-4 { color: #27ae60; }
   .engagement-score.score-3 { color: #27ae60; }
   .engagement-score.score-2 { color: #f39c12; }
   .engagement-score.score-1 { color: #e74c3c; }
   .engagement-score.score-0 { color: #e74c3c; }
   
   /* Tab styles for Profile History and Tutor Memory */
   .tab-button {
       background: #f8f9fa;
       border: none;
       border-bottom: 3px solid transparent;
       padding: 1rem 1.5rem;
       cursor: pointer;
       font-weight: 600;
       color: #6c757d;
       transition: all 0.3s ease;
   }
   .tab-button:hover {
       background: #e9ecef;
       color: #495057;
   }
   .tab-button.active {
       background: white;
       color: #2c3e50;
       border-bottom-color: #3498db;
   }
   .tab-content {
       display: none;
       padding: 0 1.5rem 1.5rem 1.5rem;
   }
   .tab-content.active {
       display: block;
   }
   
   /* Profile history styles */
   .profile-version {
       border-left: 4px solid #3498db;
       background: #f8f9fa;
       padding: 1rem;
       margin-bottom: 1rem;
       border-radius: 0 8px 8px 0;
   }
   .profile-version.current {
       border-left-color: #27ae60;
       background: #f0f9f0;
   }
   .profile-version-header {
       display: flex;
       justify-content: space-between;
       align-items: center;
       margin-bottom: 0.5rem;
   }
   .profile-version-date {
       font-weight: 600;
       color: #2c3e50;
   }
   .profile-version-narrative {
       margin: 0.5rem 0;
       font-style: italic;
       color: #555;
   }
   .profile-traits {
       display: flex;
       gap: 0.5rem;
       flex-wrap: wrap;
       margin-top: 0.5rem;
   }
   .profile-trait {
       background: #e3f2fd;
       color: #1976d2;
       padding: 4px 8px;
       border-radius: 12px;
       font-size: 0.8rem;
   }
   
   /* Memory editor styles */
   .memory-scope {
       border: 1px solid #dee2e6;
       border-radius: 8px;
       margin-bottom: 1rem;
       overflow: hidden;
   }
   .memory-scope-header {
       background: #f8f9fa;
       padding: 1rem;
       border-bottom: 1px solid #dee2e6;
       display: flex;
       justify-content: space-between;
       align-items: center;
   }
   .memory-scope-title {
       font-weight: 600;
       color: #2c3e50;
   }
   .memory-scope-description {
       font-size: 0.9rem;
       color: #666;
       margin: 0.25rem 0 0 0;
   }
   .memory-entries {
       padding: 1rem;
   }
   .memory-entry {
       display: grid;
       grid-template-columns: 200px 1fr auto;
       gap: 1rem;
       align-items: center;
       padding: 0.5rem 0;
       border-bottom: 1px solid #f1f3f4;
   }
   .memory-entry:last-child {
       border-bottom: none;
   }
   .memory-key {
       font-weight: 600;
       color: #495057;
   }
   .memory-value {
       color: #666;
   }
   .memory-actions {
       display: flex;
       gap: 0.25rem;
   }
   .btn-small {
       padding: 4px 8px;
       font-size: 0.75rem;
       border: none;
       border-radius: 4px;
       cursor: pointer;
   }
   .btn-edit {
       background: #ffc107;
       color: #212529;
   }
   .btn-delete {
       background: #dc3545;
       color: white;
   }
   
   /* Modal styles for memory editor */
   .modal {
       display: none;
       position: fixed;
       z-index: 1000;
       left: 0;
       top: 0;
       width: 100%;
       height: 100%;
       background-color: rgba(0,0,0,0.5);
   }
   .modal-content {
       background-color: #fefefe;
       margin: 5% auto;
       padding: 2rem;
       border-radius: 8px;
       width: 90%;
       max-width: 600px;
   }
   .modal-header {
       display: flex;
       justify-content: space-between;
       align-items: center;
       margin-bottom: 1.5rem;
   }
   .modal-title {
       margin: 0;
       color: #2c3e50;
   }
   .close {
       color: #aaa;
       font-size: 28px;
       font-weight: bold;
       cursor: pointer;
   }
   .close:hover {
       color: #000;
   }
   .form-group {
       margin-bottom: 1rem;
   }
   .form-group label {
       display: block;
       margin-bottom: 0.5rem;
       font-weight: 600;
       color: #495057;
   }
   .form-group input,
   .form-group select,
   .form-group textarea {
       width: 100%;
       padding: 0.5rem;
       border: 1px solid #ced4da;
       border-radius: 4px;
       font-size: 0.9rem;
   }
   .form-group textarea {
       resize: vertical;
       min-height: 80px;
   }
   
   /* Mastery Map styles */
   .mastery-overview {
       display: grid;
       grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
       gap: 1rem;
       margin-bottom: 2rem;
   }
   .mastery-stat-card {
       background: #f8f9fa;
       padding: 1.5rem;
       border-radius: 8px;
       text-align: center;
       border-left: 4px solid #3498db;
   }
   .mastery-stat-value {
       font-size: 2rem;
       font-weight: bold;
       color: #2c3e50;
       margin-bottom: 0.5rem;
   }
   .mastery-stat-label {
       color: #666;
       font-size: 0.9rem;
   }
   .mastery-subject-section {
       margin-bottom: 2rem;
       border: 1px solid #e9ecef;
       border-radius: 8px;
       padding: 1.5rem;
       background: #f8f9fa;
   }
   .mastery-subject-header {
       display: flex;
       justify-content: space-between;
       align-items: center;
       margin-bottom: 1rem;
   }
   .mastery-subject-title {
       font-size: 1.2rem;
       font-weight: 600;
       color: #2c3e50;
   }
   .mastery-percentage {
       font-size: 1.1rem;
       font-weight: bold;
       padding: 4px 12px;
       border-radius: 12px;
       color: white;
   }
   .mastery-high { background: #27ae60; }
   .mastery-medium { background: #f39c12; }
   .mastery-low { background: #e74c3c; }
   .mastery-none { background: #95a5a6; }
   .mastery-goals-grid {
       display: grid;
       grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
       gap: 1rem;
       margin-bottom: 1.5rem;
   }
   .mastery-goal-card {
       background: white;
       border: 1px solid #dee2e6;
       border-radius: 6px;
       padding: 1rem;
       border-left: 4px solid #3498db;
   }
   .mastery-goal-header {
       display: flex;
       justify-content: space-between;
       align-items: center;
       margin-bottom: 0.5rem;
   }
   .mastery-goal-code {
       font-weight: bold;
       color: #2c3e50;
   }
   .mastery-goal-title {
       font-size: 0.9rem;
       color: #555;
       margin-bottom: 0.5rem;
   }
   .mastery-kc-list {
       margin-top: 0.75rem;
   }
   .mastery-kc-item {
       display: flex;
       justify-content: space-between;
       align-items: center;
       padding: 4px 8px;
       margin: 2px 0;
       background: #f1f3f4;
       border-radius: 4px;
       font-size: 0.8rem;
   }
   .mastery-kc-name {
       color: #495057;
   }
   .mastery-kc-percentage {
       font-weight: bold;
       color: #666;
   }
   .mastery-toggle-buttons {
       display: flex;
       gap: 0.5rem;
       margin-bottom: 1rem;
   }
   .mastery-view-toggle {
       padding: 6px 12px;
       border: 1px solid #dee2e6;
       background: #f8f9fa;
       color: #495057;
       border-radius: 4px;
       cursor: pointer;
       font-size: 0.8rem;
   }
   .mastery-view-toggle.active {
       background: #007bff;
       color: white;
       border-color: #007bff;
   }
</style>
{% endblock %}
{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('main.admin_dashboard') }}">📊 Dashboard</a> /
    <a href="{{ url_for('main.admin_students') }}">👥 Students</a> /
    <span>{{ student.name }}</span>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="color: #2c3e50;">{{ student.name }}</h1>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('main.edit_student', student_id=student.id) }}" class="btn" style="background: #f39c12; text-decoration: none;">
            ✏️ Edit Student
        </a>
        <button class="btn btn-danger" onclick="deleteStudent('{{ student.id }}', '{{ student.name }}')">
            🗑️ Delete
        </button>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem; margin-bottom: 2rem;">
    <div class="card">
        <h2>👤 Student Information</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <label style="font-weight: 600; color: #666;">Student ID</label>
                <p style="margin: 5px 0 15px 0; font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 4px;">{{ student.id }}</p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Student Type</label>
                <p style="margin: 5px 0 15px 0;">
                    {% if profile.student_type %}
                        {% if profile.student_type == 'local' %}
                            <span style="background: #e8f5e8; color: #2d5a3d; padding: 6px 12px; border-radius: 12px;">
                                {{ profile.student_type|title }}
                            </span>
                        {% else %}
                            <span style="background: #fff3cd; color: #856404; padding: 6px 12px; border-radius: 12px;">
                                {{ profile.student_type|title }}
                            </span>
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">Not specified</span>
                    {% endif %}
                </p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">First Name</label>
                <p style="margin: 5px 0 15px 0;">{{ profile.first_name or 'Not provided' }}</p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Last Name</label>
                <p style="margin: 5px 0 15px 0;">{{ profile.last_name or 'Not provided' }}</p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Date of Birth</label>
                <p style="margin: 5px 0 15px 0;">
                    {% if profile.date_of_birth %}
                        📅 {{ profile.date_of_birth }}
                    {% else %}
                        <span style="color: #6c757d;">Not provided</span>
                    {% endif %}
                </p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Grade Level</label>
                <p style="margin: 5px 0 15px 0;">
                    <span style="background: #e8f5e8; color: #2d5a3d; padding: 6px 12px; border-radius: 12px;">
                        {{ student.grade }}
                    </span>
                </p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Age</label>
                <p style="margin: 5px 0 15px 0;">{{ student.age }}</p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Phone Number</label>
                <p style="margin: 5px 0 15px 0;">
                    {% if student.phone %}
                        <span style="color: #27ae60;">📱 {{ student.phone }}</span>
                    {% else %}
                        <span style="color: #e74c3c;">❌ Not configured</span>
                    {% endif %}
                </p>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label style="font-weight: 600; color: #666;">Interests</label>
                <div style="margin: 5px 0 15px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                    {% for interest in student.interests %}
                        <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 0.9rem;">
                            {{ interest }}
                        </span>
                    {% endfor %}
                </div>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label style="font-weight: 600; color: #666;">Learning Preferences</label>
                <div style="margin: 5px 0 15px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                    {% for preference in student.learning_preferences %}
                        <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 12px; font-size: 0.9rem;">
                            {{ preference }}
                        </span>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Timestamps Section -->
            <div style="grid-column: 1 / -1; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                <label style="font-weight: 600; color: #666; margin-bottom: 0.5rem; display: block;">📅 Record Timestamps</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem; color: #666;">
                    <div>
                        <strong>Created:</strong>
                        {% if profile.created_at %}
                            {{ profile.created_at.split('T')[0] if 'T' in profile.created_at else profile.created_at.split(' ')[0] }}
                            <span style="color: #999;">{{ profile.created_at.split('T')[1][:8] if 'T' in profile.created_at else (profile.created_at.split(' ')[1][:8] if ' ' in profile.created_at else '') }}</span>
                        {% else %}
                            <span style="color: #6c757d;">Unknown</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong>Last Updated:</strong>
                        {% if profile.updated_at %}
                            {{ profile.updated_at.split('T')[0] if 'T' in profile.updated_at else profile.updated_at.split(' ')[0] }}
                            <span style="color: #999;">{{ profile.updated_at.split('T')[1][:8] if 'T' in profile.updated_at else (profile.updated_at.split(' ')[1][:8] if ' ' in profile.updated_at else '') }}</span>
                        {% else %}
                            <span style="color: #6c757d;">Unknown</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div class="card" style="text-align: center;">
            <h3 style="margin-bottom: 1rem;">📈 Progress Overview</h3>
            <div class="progress-circle" style="--progress: {{ progress.overall_progress }}%;">
                <div class="progress-circle-inner">
                    <span class="progress-circle-text">{{ progress.overall_progress }}%</span>
                </div>
            </div>
            <p style="color: #666; font-size: 0.9rem;">Overall Progress</p>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom: 1rem;">📊 Quick Stats</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Sessions:</span>
                    <strong>{{ session_count }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Last Active:</span>
                    <strong>{{ last_session or 'Never' }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Streak:</span>
                    <strong>{{ progress.streak_days }} days</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New tabs for Profile History and Tutor Memory -->
<div class="card" style="margin-bottom: 2rem;">
    <div style="border-bottom: 1px solid #dee2e6;">
        <nav style="display: flex; gap: 0; margin: -1.5rem -1.5rem 0 -1.5rem;">
            <button class="tab-button active" onclick="showTab('overview')" id="tab-overview">
                📊 Overview
            </button>
            <button class="tab-button" onclick="showTab('profile-history')" id="tab-profile-history">
                📜 Profile History
            </button>
            <button class="tab-button" onclick="showTab('tutor-memory')" id="tab-tutor-memory">
                🧠 Tutor Memory
            </button>
            <button class="tab-button" onclick="showTab('mastery-map')" id="tab-mastery-map">
                🎯 Mastery Map
            </button>
        </nav>
    </div>
    
    <!-- Overview Tab (default visible) -->
    <div id="content-overview" class="tab-content active">
        <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">📊 Student Overview</h3>
        <p style="color: #666;">Quick overview of student progress and recent activity. For detailed curriculum information, see the Subject Progress section below.</p>
    </div>
    
    <!-- Profile History Tab -->
    <div id="content-profile-history" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; margin-bottom: 1rem;">
            <h3 style="margin: 0;">📜 Profile History</h3>
            <button class="btn" onclick="refreshProfileHistory()" style="background: #17a2b8; color: white; font-size: 0.8rem;">
                🔄 Refresh
            </button>
        </div>
        <div id="profile-history-container">
            <div style="text-align: center; padding: 2rem; color: #666;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
                <p>Loading profile history...</p>
            </div>
        </div>
    </div>
    
    <!-- Tutor Memory Tab -->
    <div id="content-tutor-memory" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; margin-bottom: 1rem;">
            <h3 style="margin: 0;">🧠 Tutor Memory</h3>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn" onclick="refreshTutorMemory()" style="background: #17a2b8; color: white; font-size: 0.8rem;">
                    🔄 Refresh
                </button>
                <button class="btn" onclick="addMemoryEntry()" style="background: #28a745; color: white; font-size: 0.8rem;">
                    ➕ Add Memory
                </button>
            </div>
        </div>
        <div id="tutor-memory-container">
            <div style="text-align: center; padding: 2rem; color: #666;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
                <p>Loading tutor memory...</p>
            </div>
        </div>
        
        <!-- Mastery Map Tab -->
        <div id="content-mastery-map" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; margin-bottom: 1rem;">
                <h3 style="margin: 0;">🎯 Curriculum Mastery Map</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="refreshMasteryMap()" style="background: #17a2b8; color: white; font-size: 0.8rem;">
                        🔄 Refresh
                    </button>
                    <button class="btn" onclick="toggleMasteryView()" style="background: #6c757d; color: white; font-size: 0.8rem;">
                        📊 Toggle View
                    </button>
                </div>
            </div>
            <div id="mastery-map-container">
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
                    <p>Loading mastery map...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="grid-container">
    <div class="card">
        <h2> Subject Progress</h2>
        {% if progress.subjects %}
            <div class="progress-list">
                {% for subject, data in progress.subjects.items() %}
                <div class="progress-item">
                    <div class="progress-title">
                        <span class="subject-name">{{ subject.title() }}</span>
                        <span class="progress-percentage">{{ data.progress }}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="--progress-width: {{ data.progress }}%;"></div>
                    </div>
                    <div class="last-studied">
                        Last studied: {{ data.last_studied or 'Never' }}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="empty-state">No progress data available</p>
        {% endif %}
    </div>
    
    <div class="card">
        <h2>🎯 Learning Goals</h2>
        {% if progress.goals %}
            <div class="goal-list">
                {% for goal in progress.goals %}
                <div class="goal-item pending">
                    <div class="goal-title">
                        <span>{{ goal }}</span>
                        <span>🎯</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="empty-state">No learning goals set</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <h2>🎓 Cumulative Assessment</h2>
    {% if assessment and assessment.subjects %}
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            {% for subject, data in assessment.subjects.items() %}
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h3 style="color: #2c3e50; margin-bottom: 1rem;">{{ subject.title() }}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="font-weight: 600; color: #666;">Mastery Level</label>
                        <p style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">{{ (data.overall_mastery * 100)|round }}%</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #666;">Last Assessed</label>
                        <p>{{ data.last_assessed.split('T')[0] }}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #666;">Strengths</label>
                        <ul style="padding-left: 20px;">
                            {% for strength in data.strengths %}
                                <li>{{ strength }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #666;">Weaknesses</label>
                         <ul style="padding-left: 20px;">
                            {% for weakness in data.weaknesses %}
                                <li style="color: #c0392b;">{{ weakness }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label style="font-weight: 600; color: #666;">Knowledge Gaps</label>
                        <ul style="padding-left: 20px;">
                            {% for gap in data.knowledge_gaps %}
                                <li>{{ gap }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="color: #666; font-style: italic;">No assessment data available for this student.</p>
    {% endif %}
</div>

<!-- Student Subjects and Curriculum Information -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="color: #2c3e50; margin: 0;">📚 Student Subjects & Curriculum</h2>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            {% if progress.grade_filter_applied and progress.subjects_filtered_count > 0 %}
            <button
                id="gradeFilterToggle"
                class="btn"
                style="background: #28a745; color: white; font-size: 0.8rem; padding: 6px 12px;"
                onclick="toggleGradeFilter()"
                title="Currently showing Grade {{ progress.student_grade }} subjects only. Click to show all {{ progress.subjects_filtered_count + progress.student_subjects_detailed|length }} subjects."
            >
                📚 Grade {{ progress.student_grade }} ({{ progress.student_subjects_detailed|length }})
            </button>
            {% elif not progress.grade_filter_applied and progress.student_grade and progress.student_grade != 'Unknown' %}
            <button
                id="gradeFilterToggle"
                class="btn"
                style="background: #6c757d; color: white; font-size: 0.8rem; padding: 6px 12px;"
                onclick="toggleGradeFilter()"
                title="Currently showing all {{ progress.student_subjects_detailed|length }} subjects. Click to show only Grade {{ progress.student_grade }} subjects."
            >
                📚 All Subjects ({{ progress.student_subjects_detailed|length }})
            </button>
            {% endif %}
            <button
                class="btn"
                style="background: #17a2b8; color: white; font-size: 0.8rem; padding: 6px 12px;"
                onclick="debugStudentSubjects('{{ student.id }}')"
                title="Debug curriculum assignment issues"
            >
                🔍 Debug
            </button>
            <button
                class="btn"
                style="background: #dc3545; color: white; font-size: 0.8rem; padding: 6px 12px;"
                onclick="deleteAndReassignCurriculum('{{ student.id }}', '{{ student.name }}')"
                title="Delete all current assignments and reassign default curriculum"
            >
                🔄 Reset Curriculum
            </button>
        </div>
    </div>
    
    {% if progress.student_subjects_detailed %}
        <div style="margin-bottom: 1rem;">
            {% if progress.grade_filter_applied and progress.subjects_filtered_count > 0 %}
            <div id="filterInfo" style="background: #e8f5e8; border-left: 4px solid #28a745; padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #155724;">📚 Grade-Relevant Subjects (Default)</strong>
                        <p style="color: #155724; margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                            Showing {{ progress.student_subjects_detailed|length }} subjects for Grade {{ progress.student_grade }}
                            ({{ progress.subjects_filtered_count }} other grade subjects available)
                        </p>
                    </div>
                    <button
                        onclick="toggleGradeFilter()"
                        style="background: #fff; border: 1px solid #28a745; color: #28a745; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                        Show All {{ progress.subjects_filtered_count + progress.student_subjects_detailed|length }}
                    </button>
                </div>
            </div>
            {% else %}
            <div style="background: #f8f9fa; border-left: 4px solid #6c757d; padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #495057;">📚 All Subjects Displayed</strong>
                        <p style="color: #495057; margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                            Showing all {{ progress.student_subjects_detailed|length }} subjects assigned to this student across all grade levels.
                        </p>
                    </div>
                    {% if progress.student_grade and progress.student_grade != 'Unknown' %}
                    <button
                        onclick="toggleGradeFilter()"
                        style="background: #28a745; border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                        Show Grade {{ progress.student_grade }} Only
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        {% for subject in progress.student_subjects_detailed %}
        <div class="subject-detail-section" style="margin-bottom: 2rem; border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; background: #f8f9fa;">
            <!-- Subject Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h3 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        📖 {{ subject.subject_name }}
                        {% if subject.is_core_subject %}
                        <span class="badge" style="background: #e74c3c; color: white; font-size: 0.7rem;">CORE</span>
                        {% endif %}
                        {% if subject.is_mandatory %}
                        <span class="badge" style="background: #f39c12; color: white; font-size: 0.7rem;">MANDATORY</span>
                        {% endif %}
                    </h3>
                    <p style="color: #7f8c8d; margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                        {{ subject.subject_description or 'No description available' }}
                    </p>
                    <div style="margin-top: 0.5rem;">
                        <span class="badge" style="background: #3498db; color: white; font-size: 0.7rem;">{{ subject.subject_category or 'General' }}</span>
                        <span class="badge" style="background: #7f8c8d; color: white; font-size: 0.7rem;">Grade {{ subject.grade_level }}</span>
                        {% if subject.curriculum_is_default %}
                        <span class="badge" style="background: #27ae60; color: white; font-size: 0.7rem;">DEFAULT CURRICULUM</span>
                        {% endif %}
                    </div>
                </div>
                <div style="text-align: right;">
                    {% if subject.is_active_for_tutoring %}
                    <span class="badge" style="background: #27ae60; color: white;">ACTIVE</span>
                    {% else %}
                    <span class="badge" style="background: #95a5a6; color: white;">INACTIVE</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Subject Details Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <!-- Learning Goals & Objectives -->
                <div>
                    <h4 style="color: #34495e; margin: 0 0 0.5rem 0; font-size: 1rem;">🎯 Learning Objectives</h4>
                    {% if subject.learning_objectives %}
                    <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; color: #555;">
                        {% for objective in subject.learning_objectives %}
                        <li style="margin-bottom: 0.25rem;">{{ objective }}</li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p style="color: #7f8c8d; font-style: italic; margin: 0;">No learning objectives defined</p>
                    {% endif %}
                    
                    {% if subject.goals_description %}
                    <div style="margin-top: 0.75rem;">
                        <h5 style="color: #34495e; margin: 0 0 0.25rem 0; font-size: 0.9rem;">📝 Goals Description</h5>
                        <p style="color: #555; font-size: 0.9rem; margin: 0;">{{ subject.goals_description }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Assessment & Progress -->
                <div>
                    <h4 style="color: #34495e; margin: 0 0 0.5rem 0; font-size: 1rem;">📊 Student Progress</h4>
                    
                    <!-- Progress Metrics -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
                        {% if subject.progress_percentage is not none %}
                        <div>
                            <span style="font-size: 0.8rem; color: #7f8c8d;">Progress:</span>
                            <div style="font-weight: bold; color: #27ae60;">{{ subject.progress_percentage }}%</div>
                        </div>
                        {% endif %}
                        
                        {% if subject.completion_percentage is not none %}
                        <div>
                            <span style="font-size: 0.8rem; color: #7f8c8d;">Completion:</span>
                            <div style="font-weight: bold; color: #3498db;">{{ subject.completion_percentage }}%</div>
                        </div>
                        {% endif %}
                        
                        {% if subject.mastery_level %}
                        <div>
                            <span style="font-size: 0.8rem; color: #7f8c8d;">Mastery:</span>
                            <div style="font-weight: bold; color: #9b59b6;">{{ subject.mastery_level|title }}</div>
                        </div>
                        {% endif %}
                        
                        {% if subject.grade_score %}
                        <div>
                            <span style="font-size: 0.8rem; color: #7f8c8d;">Grade:</span>
                            <div style="font-weight: bold; color: #e67e22;">{{ subject.grade_score }}</div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Assessment Criteria -->
                    {% if subject.assessment_criteria %}
                    <div style="margin-bottom: 0.75rem;">
                        <h5 style="color: #34495e; margin: 0 0 0.25rem 0; font-size: 0.85rem;">📋 Assessment Criteria</h5>
                        <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                            {% for criteria in subject.assessment_criteria %}
                            <span style="background: #ecf0f1; color: #2c3e50; padding: 2px 6px; border-radius: 12px; font-size: 0.75rem;">{{ criteria }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Comments Section -->
            <div style="margin-top: 1rem; border-top: 1px solid #ecf0f1; padding-top: 1rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- Teacher Comments -->
                    <div>
                        <h5 style="color: #34495e; margin: 0 0 0.5rem 0; font-size: 0.9rem;">👩‍🏫 Teacher Notes & Comments</h5>
                        {% if subject.teacher_notes %}
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="font-size: 0.8rem; color: #856404;">Teacher Notes:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #856404;">{{ subject.teacher_notes }}</p>
                        </div>
                        {% endif %}
                        {% if subject.comments_teacher %}
                        <div style="background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 0.5rem;">
                            <strong style="font-size: 0.8rem; color: #0c5460;">Teacher Comments:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #0c5460;">{{ subject.comments_teacher }}</p>
                        </div>
                        {% endif %}
                        {% if not subject.teacher_notes and not subject.comments_teacher %}
                        <p style="color: #7f8c8d; font-style: italic; margin: 0; font-size: 0.85rem;">No teacher comments available</p>
                        {% endif %}
                    </div>
                    
                    <!-- AI Tutor Analysis -->
                    <div>
                        <h5 style="color: #34495e; margin: 0 0 0.5rem 0; font-size: 0.9rem;">🤖 AI Tutor Analysis</h5>
                        {% if subject.ai_tutor_notes %}
                        <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="font-size: 0.8rem; color: #155724;">AI Notes:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #155724;">{{ subject.ai_tutor_notes }}</p>
                        </div>
                        {% endif %}
                        {% if subject.ai_assessment %}
                        <div style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="font-size: 0.8rem; color: #721c24;">AI Assessment:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #721c24;">{{ subject.ai_assessment }}</p>
                        </div>
                        {% endif %}
                        {% if subject.weaknesses %}
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 0.5rem;">
                            <strong style="font-size: 0.8rem; color: #856404;">Areas for Improvement:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #856404;">{{ subject.weaknesses }}</p>
                        </div>
                        {% endif %}
                        {% if not subject.ai_tutor_notes and not subject.ai_assessment and not subject.weaknesses %}
                        <p style="color: #7f8c8d; font-style: italic; margin: 0; font-size: 0.85rem;">No AI analysis available</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Grade Motivation -->
                {% if subject.grade_motivation %}
                <div style="margin-top: 0.75rem; background: #e7f3ff; border-radius: 6px; padding: 0.75rem;">
                    <h6 style="color: #0066cc; margin: 0 0 0.25rem 0; font-size: 0.85rem;">💪 Motivational Feedback</h6>
                    <p style="margin: 0; font-size: 0.9rem; color: #004080;">{{ subject.grade_motivation }}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Additional Information -->
            <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.85rem; color: #666;">
                {% if subject.recommended_hours_per_week %}
                <div>
                    <strong>Recommended Hours/Week:</strong> {{ subject.recommended_hours_per_week }}
                </div>
                {% endif %}
                <div>
                    <strong>Curriculum:</strong> {{ subject.curriculum_name }} ({{ subject.curriculum_type or 'General' }})
                </div>
                {% if subject.updated_at %}
                <div>
                    <strong>Last Updated:</strong> {{ subject.updated_at.split('T')[0] if 'T' in subject.updated_at else subject.updated_at }}
                </div>
                {% endif %}
            </div>
            
            <!-- Prerequisites and Resources -->
            {% if subject.prerequisites or subject.resources %}
            <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                {% if subject.prerequisites %}
                <div>
                    <h6 style="color: #34495e; margin: 0 0 0.25rem 0; font-size: 0.8rem;">📋 Prerequisites</h6>
                    <ul style="margin: 0; padding-left: 1rem; font-size: 0.75rem; color: #666;">
                        {% for prerequisite in subject.prerequisites %}
                        <li>{{ prerequisite }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if subject.resources %}
                <div>
                    <h6 style="color: #34495e; margin: 0 0 0.25rem 0; font-size: 0.8rem;">📚 Resources</h6>
                    <ul style="margin: 0; padding-left: 1rem; font-size: 0.75rem; color: #666;">
                        {% for resource in subject.resources %}
                        <li>{{ resource }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
    <div style="text-align: center; padding: 2rem; color: #666;">
        <div style="font-size: 2rem; margin-bottom: 1rem;">📚</div>
        <h4>No Subjects Assigned</h4>
        <p>This student doesn't have any subjects assigned yet.</p>
        <p style="color: #7f8c8d; font-size: 0.9rem;">
            Subjects are automatically assigned when students are created if a default curriculum is available.
        </p>
        <div style="margin-top: 1.5rem;">
            <button
                class="btn"
                style="background: #27ae60; color: white; text-decoration: none;"
                onclick="assignDefaultCurriculum('{{ student.id }}', '{{ student.name }}')"
            >
                📚 Assign Default Curriculum
            </button>
        </div>
    </div>
    {% endif %}
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>🕒 Recent Sessions</h2>
        <a href="{{ url_for('main.view_student_sessions', student_id=student.id) }}" class="btn">
            📁 View All Sessions
        </a>
    </div>
    
    {% if recent_sessions %}
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>📅 Date</th>
                        <th>⏱️ Duration</th>
                        <th>📚 Topics Covered</th>
                        <th>📊 Engagement</th>
                        <th>⚡ Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in recent_sessions %}
                    <tr>
                        <td>{{ session.date }}</td>
                        <td>{{ session.duration }} min</td>
                        <td>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                {% for topic in session.topics %}
                                    <span style="background: #e8f5e8; color: #2d5a3d; padding: 2px 6px; border-radius: 8px; font-size: 0.8rem;">
                                        {{ topic }}
                                    </span>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <span class="engagement-score score-{{ session.engagement // 20 }}">
                                {{ session.engagement }}%
                            </span>
                        </td>
                        <td>
                            {% if session.file %}
                                <a href="{{ url_for('main.view_session_detail', student_id=student.id, session_file=session.file) }}"
                                   class="btn"
                                   style="padding: 4px 8px; font-size: 0.8rem;">
                                    👁️ View
                                </a>
                            {% elif session.id %}
                                <span class="btn"
                                      style="padding: 4px 8px; font-size: 0.8rem; background: #6c757d; color: white;"
                                      title="Database session - detailed view coming soon">
                                    📊 DB Session
                                </span>
                            {% else %}
                                <span style="color: #6c757d; font-size: 0.8rem;">No details</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 2rem; color: #666;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">🕒</div>
            <h4>No Sessions Yet</h4>
            <p>This student hasn't had any tutoring sessions yet.</p>
        </div>
    {% endif %}
</div>

<!-- Memory Editor Modal -->
<div id="memoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add Memory Entry</h3>
            <span class="close" onclick="closeMemoryModal()">&times;</span>
        </div>
        <form id="memoryForm">
            <div class="form-group">
                <label for="memoryScope">Scope:</label>
                <select id="memoryScope" name="scope" required>
                    <option value="">Select a scope...</option>
                    <option value="personal_fact">👤 Personal Fact</option>
                    <option value="game_state">🎮 Game State</option>
                    <option value="strategy_log">📚 Strategy Log</option>
                </select>
            </div>
            <div class="form-group">
                <label for="memoryKey">Memory Key:</label>
                <input type="text" id="memoryKey" name="key" required
                       placeholder="e.g., favorite_color, current_level, learning_strategy">
            </div>
            <div class="form-group">
                <label for="memoryValue">Memory Value:</label>
                <textarea id="memoryValue" name="value" required
                          placeholder="Enter the memory value or description"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn" onclick="closeMemoryModal()"
                        style="background: #6c757d; color: white;">
                    Cancel
                </button>
                <button type="submit" class="btn" style="background: #28a745; color: white;">
                    Save Memory
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function deleteStudent(studentId, studentName) {
    if (!confirm(`Are you sure you want to delete student "${studentName}"?\n\nThis action will permanently delete:\n• Student profile and personal data\n• All curriculum assignments and progress\n• All session records and transcripts\n• Assessment data and analytics\n• Phone number mapping\n• AI tutor analysis and notes\n\n⚠️ This action cannot be undone and will completely remove all data associated with this student.`)) {
        return;
    }
    
    // Show loading state
    const deleteBtn = event.target;
    const originalText = deleteBtn.textContent;
    deleteBtn.textContent = '🔄 Deleting...';
    deleteBtn.disabled = true;
    
    fetch(`/admin/students/${studentId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`✅ ${data.message}`);
            // Redirect to students list
            window.location.href = data.redirect;
        } else {
            alert(`❌ Error: ${data.error}`);
            // Restore button state
            deleteBtn.textContent = originalText;
            deleteBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Delete request failed:', error);
        alert(`❌ Failed to delete student: ${error.message}`);
        // Restore button state
        deleteBtn.textContent = originalText;
        deleteBtn.disabled = false;
    });
}

function assignDefaultCurriculum(studentId, studentName) {
    if (!confirm(`Assign default curriculum to "${studentName}"?\n\nThis will add all subjects from the default Cambridge Primary 2025 curriculum to this student.`)) {
        return;
    }
    
    // Show loading state
    const assignBtn = event.target;
    const originalText = assignBtn.textContent;
    assignBtn.textContent = '🔄 Assigning...';
    assignBtn.disabled = true;
    
    fetch(`/admin/students/${studentId}/assign-curriculum`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`✅ ${data.message}`);
            // Reload the page to show the assigned subjects
            window.location.reload();
        } else {
            alert(`❌ Error: ${data.error}`);
            // Restore button state
            assignBtn.textContent = originalText;
            assignBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Assign curriculum request failed:', error);
        alert(`❌ Failed to assign curriculum: ${error.message}`);
        // Restore button state
        assignBtn.textContent = originalText;
        assignBtn.disabled = false;
    });
}

function debugStudentSubjects(studentId) {
    // Show loading state
    const debugBtn = event.target;
    const originalText = debugBtn.textContent;
    debugBtn.textContent = '🔄 Debugging...';
    debugBtn.disabled = true;
    
    fetch(`/admin/debug/student/${studentId}/subjects`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create a detailed debug report
            let debugReport = `=== CURRICULUM DEBUG REPORT ===\n`;
            debugReport += `Student ID: ${data.debug_info.student_id}\n\n`;
            
            debugReport += `📊 SUMMARY:\n`;
            debugReport += `• Total StudentSubject records: ${data.debug_info.total_student_subjects}\n`;
            debugReport += `• Detailed subjects query matches: ${data.debug_info.detailed_subjects_count}\n`;
            debugReport += `• Admin query successful: ${data.debug_info.admin_query_successful}\n`;
            
            if (data.debug_info.default_curriculum) {
                debugReport += `• Default curriculum exists: ${data.debug_info.default_curriculum.exists}\n`;
                if (data.debug_info.default_curriculum.exists) {
                    debugReport += `• Default curriculum: ${data.debug_info.default_curriculum.name} (ID: ${data.debug_info.default_curriculum.id})\n`;
                }
            }
            
            debugReport += `\n📋 RAW STUDENT SUBJECT RECORDS:\n`;
            if (data.debug_info.student_subjects_raw.length > 0) {
                data.debug_info.student_subjects_raw.forEach((ss, index) => {
                    debugReport += `${index + 1}. ID: ${ss.id}, Curriculum Detail ID: ${ss.curriculum_detail_id}\n`;
                    debugReport += `   Active: ${ss.is_active_for_tutoring}, In Use: ${ss.is_in_use}\n`;
                    debugReport += `   Progress: ${ss.progress_percentage}%, Created: ${ss.created_at}\n\n`;
                });
            } else {
                debugReport += `No StudentSubject records found.\n`;
            }
            
            debugReport += `\n📚 DETAILED SUBJECTS INFO:\n`;
            if (data.debug_info.detailed_subjects_info.length > 0) {
                data.debug_info.detailed_subjects_info.forEach((subj, index) => {
                    debugReport += `${index + 1}. ${subj.subject_name} (Grade ${subj.grade_level})\n`;
                    debugReport += `   Curriculum: ${subj.curriculum_name} (Default: ${subj.curriculum_is_default})\n`;
                    debugReport += `   Category: ${subj.subject_category}, Mandatory: ${subj.is_mandatory}\n`;
                    debugReport += `   Progress: ${subj.progress_percentage}%, Active: ${subj.is_active_for_tutoring}\n`;
                    debugReport += `   Learning Objectives: ${subj.learning_objectives_count}, Assessment Criteria: ${subj.assessment_criteria_count}\n\n`;
                });
            } else {
                debugReport += `No detailed subject information found.\n`;
            }
            
            if (data.debug_info.admin_query_error) {
                debugReport += `\n❌ ADMIN QUERY ERROR:\n${data.debug_info.admin_query_error}\n`;
            }
            
            if (data.debug_info.default_curriculum_error) {
                debugReport += `\n❌ DEFAULT CURRICULUM ERROR:\n${data.debug_info.default_curriculum_error}\n`;
            }
            
            // Show the debug report in an alert (for now) - could be improved with a modal
            alert(debugReport);
        } else {
            alert(`❌ Debug Error: ${data.error}`);
        }
        
        // Restore button state
        debugBtn.textContent = originalText;
        debugBtn.disabled = false;
    })
    .catch(error => {
        console.error('Debug request failed:', error);
        alert(`❌ Failed to debug student subjects: ${error.message}`);
        // Restore button state
        debugBtn.textContent = originalText;
        debugBtn.disabled = false;
    });
}

function deleteAndReassignCurriculum(studentId, studentName) {
    if (!confirm(`⚠️ RESET CURRICULUM for "${studentName}"?\n\nThis will:\n• DELETE all existing subject assignments\n• REASSIGN the complete default curriculum\n\nThis action cannot be undone. Continue?`)) {
        return;
    }
    
    // Show loading state
    const resetBtn = event.target;
    const originalText = resetBtn.textContent;
    resetBtn.textContent = '🔄 Resetting...';
    resetBtn.disabled = true;
    
    fetch(`/admin/students/${studentId}/delete-and-reassign-curriculum`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `✅ ${data.message}`;
            if (data.deleted_count > 0) {
                message += `\n\n📋 Deleted Subjects:`;
                data.deleted_subjects.forEach((subj, index) => {
                    message += `\n${index + 1}. ${subj.subject_name} (Grade ${subj.grade_level}) - ${subj.curriculum_name}`;
                });
            }
            alert(message);
            // Reload the page to show the new assignments
            window.location.reload();
        } else {
            alert(`❌ Error: ${data.error}`);
            // Restore button state
            resetBtn.textContent = originalText;
            resetBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Reset curriculum request failed:', error);
        alert(`❌ Failed to reset curriculum: ${error.message}`);
        // Restore button state
        resetBtn.textContent = originalText;
        resetBtn.disabled = false;
    });
}

// Toggle function for grade filtering - default is filtered, toggle shows all
function toggleGradeFilter() {
    // Simple page reload approach - more reliable than complex DOM manipulation
    const currentUrl = new URL(window.location);
    const isCurrentlyShowingAll = currentUrl.searchParams.get('show_all') === 'true' || currentUrl.searchParams.get('grade_filter') === 'false';
    
    // Clean up old parameters
    currentUrl.searchParams.delete('grade_filter');
    currentUrl.searchParams.delete('show_all');
    
    if (isCurrentlyShowingAll) {
        // Currently showing all, switch to grade filter (default behavior - no parameters needed)
        // Don't add any parameters - default is grade filtering
    } else {
        // Currently showing grade filter (default), switch to show all subjects
        currentUrl.searchParams.set('show_all', 'true');
    }
    
    // Reload page with new filter state
    window.location.href = currentUrl.toString();
}

// Tab functionality for Profile History and Tutor Memory
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(`content-${tabName}`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // Load data for specific tabs
    if (tabName === 'profile-history') {
        loadProfileHistory();
    } else if (tabName === 'tutor-memory') {
        loadTutorMemory();
    } else if (tabName === 'mastery-map') {
        loadMasteryMap();
    }
}

// Profile History Functions
function loadProfileHistory() {
    const container = document.getElementById('profile-history-container');
    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div><p>Loading profile history...</p></div>';
    
    fetch(`/admin/students/{{ student.id }}/profile/history`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayProfileHistory(data.data.profile_history);
            } else {
                container.innerHTML = `<div style="text-align: center; padding: 2rem; color: #e74c3c;"><div style="font-size: 2rem; margin-bottom: 1rem;">❌</div><p>Error: ${data.message}</p></div>`;
            }
        })
        .catch(error => {
            console.error('Error loading profile history:', error);
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #e74c3c;"><div style="font-size: 2rem; margin-bottom: 1rem;">❌</div><p>Failed to load profile history</p></div>';
        });
}

function displayProfileHistory(profileHistory) {
    const container = document.getElementById('profile-history-container');
    
    if (!profileHistory || profileHistory.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><div style="font-size: 2rem; margin-bottom: 1rem;">📜</div><h4>No Profile History</h4><p>This student doesn\'t have any profile history yet.</p></div>';
        return;
    }
    
    let html = '';
    profileHistory.forEach((version, index) => {
        const isCurrentVersion = index === 0;
        const versionClass = isCurrentVersion ? 'profile-version current' : 'profile-version';
        
        html += `
            <div class="${versionClass}">
                <div class="profile-version-header">
                    <div class="profile-version-date">
                        ${isCurrentVersion ? '📌 Current Version - ' : '📅 '}
                        ${formatDate(version.created_at)}
                    </div>
                    <div style="font-size: 0.8rem; color: #666;">
                        Version ${profileHistory.length - index}
                    </div>
                </div>
                ${version.narrative ? `<div class="profile-version-narrative">"${version.narrative}"</div>` : ''}
                ${version.traits ? displayTraits(version.traits) : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function displayTraits(traits) {
    if (!traits || Object.keys(traits).length === 0) {
        return '';
    }
    
    let html = '<div class="profile-traits">';
    for (const [key, value] of Object.entries(traits)) {
        if (Array.isArray(value)) {
            value.forEach(item => {
                html += `<span class="profile-trait">${key}: ${item}</span>`;
            });
        } else {
            html += `<span class="profile-trait">${key}: ${value}</span>`;
        }
    }
    html += '</div>';
    return html;
}

function refreshProfileHistory() {
    loadProfileHistory();
}

// Tutor Memory Functions
function loadTutorMemory() {
    const container = document.getElementById('tutor-memory-container');
    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div><p>Loading tutor memory...</p></div>';
    
    fetch(`/admin/students/{{ student.id }}/memory/scopes`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTutorMemory(data.data.scopes);
            } else {
                container.innerHTML = `<div style="text-align: center; padding: 2rem; color: #e74c3c;"><div style="font-size: 2rem; margin-bottom: 1rem;">❌</div><p>Error: ${data.message}</p></div>`;
            }
        })
        .catch(error => {
            console.error('Error loading tutor memory:', error);
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #e74c3c;"><div style="font-size: 2rem; margin-bottom: 1rem;">❌</div><p>Failed to load tutor memory</p></div>';
        });
}

function displayTutorMemory(scopes) {
    const container = document.getElementById('tutor-memory-container');
    
    if (!scopes || scopes.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><div style="font-size: 2rem; margin-bottom: 1rem;">🧠</div><h4>No Memory Data</h4><p>This student doesn\'t have any tutor memory yet.</p></div>';
        return;
    }
    
    let html = '';
    scopes.forEach(scope => {
        html += `
            <div class="memory-scope">
                <div class="memory-scope-header">
                    <div>
                        <div class="memory-scope-title">${getScopeIcon(scope.name)} ${formatScopeName(scope.name)}</div>
                        <div class="memory-scope-description">${scope.description}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 0.8rem; color: #666;">${scope.current_entries} entries</span>
                        <button class="btn btn-small" onclick="addMemoryEntry('${scope.name}')" style="background: #28a745; color: white;">
                            ➕ Add
                        </button>
                    </div>
                </div>
                <div class="memory-entries">
                    ${displayMemoryEntries(scope.name, scope.entries)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function displayMemoryEntries(scopeName, entries) {
    if (!entries || Object.keys(entries).length === 0) {
        return '<div style="text-align: center; padding: 1rem; color: #666; font-style: italic;">No memories in this scope yet</div>';
    }
    
    let html = '';
    for (const [key, value] of Object.entries(entries)) {
        html += `
            <div class="memory-entry">
                <div class="memory-key">${key}</div>
                <div class="memory-value">${value}</div>
                <div class="memory-actions">
                    <button class="btn-small btn-edit" onclick="editMemoryEntry('${scopeName}', '${key}', '${escapeHtml(value)}')">✏️</button>
                    <button class="btn-small btn-delete" onclick="deleteMemoryEntry('${scopeName}', '${key}')">🗑️</button>
                </div>
            </div>
        `;
    }
    return html;
}

function getScopeIcon(scopeName) {
    const icons = {
        'personal_fact': '👤',
        'game_state': '🎮',
        'strategy_log': '📚'
    };
    return icons[scopeName] || '📝';
}

function formatScopeName(scopeName) {
    return scopeName.split('_').map(word =>
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function refreshTutorMemory() {
    loadTutorMemory();
}

// Memory Modal Functions
let currentEditingScope = null;
let currentEditingKey = null;

function addMemoryEntry(scope = null) {
    currentEditingScope = scope;
    currentEditingKey = null;
    
    document.getElementById('memoryScope').value = scope || '';
    document.getElementById('memoryKey').value = '';
    document.getElementById('memoryValue').value = '';
    document.querySelector('.modal-title').textContent = 'Add Memory Entry';
    
    document.getElementById('memoryModal').style.display = 'block';
}

function editMemoryEntry(scope, key, value) {
    currentEditingScope = scope;
    currentEditingKey = key;
    
    document.getElementById('memoryScope').value = scope;
    document.getElementById('memoryKey').value = key;
    document.getElementById('memoryValue').value = value;
    document.querySelector('.modal-title').textContent = 'Edit Memory Entry';
    
    document.getElementById('memoryModal').style.display = 'block';
}

function closeMemoryModal() {
    document.getElementById('memoryModal').style.display = 'none';
    currentEditingScope = null;
    currentEditingKey = null;
}

function deleteMemoryEntry(scope, key) {
    if (!confirm(`Are you sure you want to delete the memory entry "${key}" from ${formatScopeName(scope)}?`)) {
        return;
    }
    
    const updateData = {
        memory: {
            [scope]: {
                [key]: null  // null value indicates deletion
            }
        }
    };
    
    fetch(`/api/v1/students/{{ student.id }}/memory`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' || data.status === 'partial') {
            loadTutorMemory();  // Refresh the memory display
        } else {
            alert(`Error deleting memory: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error deleting memory:', error);
        alert('Failed to delete memory entry');
    });
}

// Handle memory form submission
document.getElementById('memoryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const scope = document.getElementById('memoryScope').value;
    const key = document.getElementById('memoryKey').value;
    const value = document.getElementById('memoryValue').value;
    
    if (!scope || !key || !value) {
        alert('Please fill in all fields');
        return;
    }
    
    const updateData = {
        memory: {
            [scope]: {
                [key]: value
            }
        }
    };
    
    fetch(`/api/v1/students/{{ student.id }}/memory`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' || data.status === 'partial') {
            closeMemoryModal();
            loadTutorMemory();  // Refresh the memory display
        } else {
            alert(`Error saving memory: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error saving memory:', error);
        alert('Failed to save memory entry');
    });
});

// Mastery Map Functions
let currentMasteryView = 'overview'; // 'overview' or 'detailed'

function loadMasteryMap() {
    const container = document.getElementById('mastery-map-container');
    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div><p>Loading mastery map...</p></div>';
    
    fetch(`/admin/students/{{ student.id }}/mastery-map`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMasteryMap(data.data);
            } else {
                container.innerHTML = `<div style="text-align: center; padding: 2rem; color: #e74c3c;"><div style="font-size: 2rem; margin-bottom: 1rem;">❌</div><p>Error: ${data.message}</p></div>`;
            }
        })
        .catch(error => {
            console.error('Error loading mastery map:', error);
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #e74c3c;"><div style="font-size: 2rem; margin-bottom: 1rem;">❌</div><p>Failed to load mastery map</p></div>';
        });
}

function displayMasteryMap(masteryData) {
    const container = document.getElementById('mastery-map-container');
    
    if (!masteryData || (!masteryData.goal_mastery && !masteryData.kc_mastery)) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><div style="font-size: 2rem; margin-bottom: 1rem;">🎯</div><h4>No Mastery Data</h4><p>This student doesn\'t have any mastery tracking data yet.</p></div>';
        return;
    }
    
    let html = '';
    
    // Add view toggle buttons
    html += `
        <div class="mastery-toggle-buttons">
            <button class="mastery-view-toggle ${currentMasteryView === 'overview' ? 'active' : ''}" onclick="switchMasteryView('overview')">
                📊 Overview
            </button>
            <button class="mastery-view-toggle ${currentMasteryView === 'detailed' ? 'active' : ''}" onclick="switchMasteryView('detailed')">
                📋 Detailed
            </button>
            <button class="mastery-view-toggle" onclick="exportMasteryData()">
                📄 Export JSON
            </button>
        </div>
    `;
    
    if (currentMasteryView === 'overview') {
        html += displayMasteryOverview(masteryData);
    } else {
        html += displayDetailedMastery(masteryData);
    }
    
    container.innerHTML = html;
}

function displayMasteryOverview(masteryData) {
    const goalMastery = masteryData.goal_mastery || {};
    const kcMastery = masteryData.kc_mastery || {};
    
    let html = `
        <div class="mastery-overview">
            <div class="mastery-stat-card">
                <div class="mastery-stat-value">${goalMastery.overall_mastery_percentage || 0}%</div>
                <div class="mastery-stat-label">Overall Goal Mastery</div>
            </div>
            <div class="mastery-stat-card">
                <div class="mastery-stat-value">${goalMastery.total_goals_tracked || 0}</div>
                <div class="mastery-stat-label">Goals Tracked</div>
            </div>
            <div class="mastery-stat-card">
                <div class="mastery-stat-value">${kcMastery.overall_kc_mastery_percentage || 0}%</div>
                <div class="mastery-stat-label">Knowledge Component Mastery</div>
            </div>
            <div class="mastery-stat-card">
                <div class="mastery-stat-value">${kcMastery.total_kcs_tracked || 0}</div>
                <div class="mastery-stat-label">KCs Tracked</div>
            </div>
        </div>
    `;
    
    // Display mastery by subject
    if (goalMastery.mastery_by_subject) {
        Object.entries(goalMastery.mastery_by_subject).forEach(([subject, data]) => {
            const percentage = Math.round(data.average_mastery_percentage || 0);
            const masteryClass = getMasteryClass(percentage);
            
            html += `
                <div class="mastery-subject-section">
                    <div class="mastery-subject-header">
                        <div class="mastery-subject-title">📚 ${subject}</div>
                        <div class="mastery-percentage ${masteryClass}">${percentage}%</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                        <div><strong>Goals:</strong> ${data.total_goals || 0}</div>
                        <div><strong>Completed:</strong> ${data.completed_goals || 0}</div>
                        <div><strong>In Progress:</strong> ${data.in_progress_goals || 0}</div>
                        <div><strong>Not Started:</strong> ${data.not_started_goals || 0}</div>
                    </div>
                </div>
            `;
        });
    }
    
    return html;
}

function displayDetailedMastery(masteryData) {
    let html = '';
    const goalMastery = masteryData.goal_mastery || {};
    
    if (goalMastery.mastery_by_subject) {
        Object.entries(goalMastery.mastery_by_subject).forEach(([subject, subjectData]) => {
            const percentage = Math.round(subjectData.average_mastery_percentage || 0);
            const masteryClass = getMasteryClass(percentage);
            
            html += `
                <div class="mastery-subject-section">
                    <div class="mastery-subject-header">
                        <div class="mastery-subject-title">📚 ${subject}</div>
                        <div class="mastery-percentage ${masteryClass}">${percentage}%</div>
                    </div>
                    <div class="mastery-goals-grid">
            `;
            
            // Display individual goals for this subject
            if (subjectData.goals) {
                subjectData.goals.forEach(goal => {
                    const goalPercentage = Math.round(goal.mastery_percentage || 0);
                    const goalMasteryClass = getMasteryClass(goalPercentage);
                    
                    html += `
                        <div class="mastery-goal-card">
                            <div class="mastery-goal-header">
                                <div class="mastery-goal-code">${goal.goal_code}</div>
                                <div class="mastery-percentage ${goalMasteryClass}" style="font-size: 0.9rem;">${goalPercentage}%</div>
                            </div>
                            <div class="mastery-goal-title">${goal.title || 'No title'}</div>
                            ${goal.knowledge_components ? displayKnowledgeComponents(goal.knowledge_components) : ''}
                        </div>
                    `;
                });
            }
            
            html += `
                    </div>
                </div>
            `;
        });
    }
    
    return html;
}

function displayKnowledgeComponents(kcs) {
    if (!kcs || kcs.length === 0) {
        return '';
    }
    
    let html = '<div class="mastery-kc-list">';
    kcs.forEach(kc => {
        const kcPercentage = Math.round(kc.mastery_percentage || 0);
        html += `
            <div class="mastery-kc-item">
                <div class="mastery-kc-name">${kc.kc_name}</div>
                <div class="mastery-kc-percentage">${kcPercentage}%</div>
            </div>
        `;
    });
    html += '</div>';
    return html;
}

function getMasteryClass(percentage) {
    if (percentage >= 80) return 'mastery-high';
    if (percentage >= 60) return 'mastery-medium';
    if (percentage > 0) return 'mastery-low';
    return 'mastery-none';
}

function switchMasteryView(view) {
    currentMasteryView = view;
    loadMasteryMap(); // Reload with new view
}

function refreshMasteryMap() {
    loadMasteryMap();
}

function toggleMasteryView() {
    currentMasteryView = currentMasteryView === 'overview' ? 'detailed' : 'overview';
    loadMasteryMap();
}

function exportMasteryData() {
    fetch(`/admin/students/{{ student.id }}/mastery-map`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const jsonStr = JSON.stringify(data.data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `student_{{ student.id }}_mastery_map.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                alert('Failed to export mastery data');
            }
        })
        .catch(error => {
            console.error('Error exporting mastery data:', error);
            alert('Failed to export mastery data');
        });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('memoryModal');
    if (event.target === modal) {
        closeMemoryModal();
    }
}
</script>
{% endblock %}