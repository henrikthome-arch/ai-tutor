{% extends "base.html" %}

{% block title %}{{ student.name }} - AI Tutor Admin{% endblock %}

{% block styles %}
<style>
    .progress-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: conic-gradient(#27ae60 var(--progress, 0%), #ecf0f1 0);
        margin: 0 auto 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .progress-circle-inner {
        width: 70px;
        height: 70px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .progress-circle-text {
        font-size: 1.2rem;
        font-weight: bold;
        color: #27ae60;
    }
    .grid-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    .progress-list, .goal-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .progress-item .progress-title {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    .progress-item .subject-name {
        font-weight: 600;
    }
    .progress-item .progress-percentage {
        color: #666;
    }
    .progress-bar-container {
        width: 100%;
        height: 8px;
        background: #ecf0f1;
        border-radius: 4px;
        overflow: hidden;
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #8e44ad);
        transition: width 0.3s ease;
    }
    .last-studied {
        margin-top: 5px;
        font-size: 0.9rem;
        color: #666;
    }
    .goal-item {
        padding: 12px;
        border-left-width: 4px;
        border-left-style: solid;
    }
    .goal-item.completed {
        border-left-color: #27ae60;
        background: #f0f9f0;
    }
    .goal-item.pending {
        border-left-color: #3498db;
        background: #f8f9fa;
    }
    .goal-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
    }
    .goal-title .completed {
        color: #27ae60;
    }
    .goal-title .pending {
        color: #3498db;
    }
    .goal-description {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 0.9rem;
    }
    .goal-target-date {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 0.8rem;
    }
   .engagement-score.score-4 { color: #27ae60; }
   .engagement-score.score-3 { color: #27ae60; }
   .engagement-score.score-2 { color: #f39c12; }
   .engagement-score.score-1 { color: #e74c3c; }
   .engagement-score.score-0 { color: #e74c3c; }
</style>
{% endblock %}
{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('admin_dashboard') }}">üìä Dashboard</a> / 
    <a href="{{ url_for('admin_students') }}">üë• Students</a> / 
    <span>{{ student.name }}</span>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="color: #2c3e50;">{{ student.name }}</h1>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('edit_student', student_id=student.id) }}" class="btn" style="background: #f39c12; text-decoration: none;">
            ‚úèÔ∏è Edit Student
        </a>
        <button class="btn btn-danger" onclick="deleteStudent('{{ student.id }}', '{{ student.name }}')">
            üóëÔ∏è Delete
        </button>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem; margin-bottom: 2rem;">
    <div class="card">
        <h2>üë§ Student Information</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <label style="font-weight: 600; color: #666;">Student ID</label>
                <p style="margin: 5px 0 15px 0; font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 4px;">{{ student.id }}</p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Grade Level</label>
                <p style="margin: 5px 0 15px 0;">
                    <span style="background: #e8f5e8; color: #2d5a3d; padding: 6px 12px; border-radius: 12px;">
                        Grade {{ student.grade }}
                    </span>
                </p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Age</label>
                <p style="margin: 5px 0 15px 0;">{{ student.age }} years old</p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Phone Number</label>
                <p style="margin: 5px 0 15px 0;">
                    {% if student.phone %}
                        <span style="color: #27ae60;">üì± {{ student.phone }}</span>
                    {% else %}
                        <span style="color: #e74c3c;">‚ùå Not configured</span>
                    {% endif %}
                </p>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label style="font-weight: 600; color: #666;">Interests</label>
                <div style="margin: 5px 0 15px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                    {% for interest in student.interests %}
                        <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 0.9rem;">
                            {{ interest }}
                        </span>
                    {% endfor %}
                </div>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label style="font-weight: 600; color: #666;">Learning Preferences</label>
                <div style="margin: 5px 0 15px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                    {% for preference in student.learning_preferences %}
                        <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 12px; font-size: 0.9rem;">
                            {{ preference }}
                        </span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div class="card" style="text-align: center;">
            <h3 style="margin-bottom: 1rem;">üìà Progress Overview</h3>
            <div class="progress-circle" style="--progress: {{ progress.overall_progress }}%;">
                <div class="progress-circle-inner">
                    <span class="progress-circle-text">{{ progress.overall_progress }}%</span>
                </div>
            </div>
            <p style="color: #666; font-size: 0.9rem;">Overall Progress</p>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom: 1rem;">üìä Quick Stats</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Sessions:</span>
                    <strong>{{ session_count }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Last Active:</span>
                    <strong>{{ last_session or 'Never' }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Streak:</span>
                    <strong>{{ progress.streak_days }} days</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="grid-container">
    <div class="card">
        <h2>üìö Subject Progress</h2>
        {% if progress.subjects %}
            <div class="progress-list">
                {% for subject, data in progress.subjects.items() %}
                <div class="progress-item">
                    <div class="progress-title">
                        <span class="subject-name">{{ subject.title() }}</span>
                        <span class="progress-percentage">{{ data.progress }}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="--progress-width: {{ data.progress }}%;"></div>
                    </div>
                    <div class="last-studied">
                        Last studied: {{ data.last_studied or 'Never' }}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="empty-state">No progress data available</p>
        {% endif %}
    </div>
    
    <div class="card">
        <h2>üéØ Learning Goals</h2>
        {% if progress.goals %}
            <div class="goal-list">
                {% for goal in progress.goals %}
                <div class="goal-item pending">
                    <div class="goal-title">
                        <span>{{ goal }}</span>
                        <span>üéØ</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="empty-state">No learning goals set</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <h2>üéì Cumulative Assessment</h2>
    {% if assessment and assessment.subjects %}
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            {% for subject, data in assessment.subjects.items() %}
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h3 style="color: #2c3e50; margin-bottom: 1rem;">{{ subject.title() }}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="font-weight: 600; color: #666;">Mastery Level</label>
                        <p style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">{{ (data.overall_mastery * 100)|round }}%</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #666;">Last Assessed</label>
                        <p>{{ data.last_assessed.split('T')[0] }}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #666;">Strengths</label>
                        <ul style="padding-left: 20px;">
                            {% for strength in data.strengths %}
                                <li>{{ strength }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #666;">Weaknesses</label>
                         <ul style="padding-left: 20px;">
                            {% for weakness in data.weaknesses %}
                                <li style="color: #c0392b;">{{ weakness }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label style="font-weight: 600; color: #666;">Knowledge Gaps</label>
                        <ul style="padding-left: 20px;">
                            {% for gap in data.knowledge_gaps %}
                                <li>{{ gap }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="color: #666; font-style: italic;">No assessment data available for this student.</p>
    {% endif %}
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>üïí Recent Sessions</h2>
        <a href="{{ url_for('view_student_sessions', student_id=student.id) }}" class="btn">
            üìÅ View All Sessions
        </a>
    </div>
    
    {% if recent_sessions %}
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>üìÖ Date</th>
                        <th>‚è±Ô∏è Duration</th>
                        <th>üìö Topics Covered</th>
                        <th>üìä Engagement</th>
                        <th>‚ö° Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in recent_sessions %}
                    <tr>
                        <td>{{ session.date }}</td>
                        <td>{{ session.duration }} min</td>
                        <td>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                {% for topic in session.topics %}
                                    <span style="background: #e8f5e8; color: #2d5a3d; padding: 2px 6px; border-radius: 8px; font-size: 0.8rem;">
                                        {{ topic }}
                                    </span>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <span class="engagement-score score-{{ session.engagement // 20 }}">
                                {{ session.engagement }}%
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('view_session_detail', student_id=student.id, session_file=session.file) }}"
                               class="btn"
                               style="padding: 4px 8px; font-size: 0.8rem;">
                                üëÅÔ∏è View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 2rem; color: #666;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">üïí</div>
            <h4>No Sessions Yet</h4>
            <p>This student hasn't had any tutoring sessions yet.</p>
        </div>
    {% endif %}
</div>

<script>
function deleteStudent(studentId, studentName) {
    if (!confirm(`Are you sure you want to delete student "${studentName}"?\n\nThis action will permanently delete:\n‚Ä¢ Student profile and data\n‚Ä¢ All session records\n‚Ä¢ Phone number mapping\n\nThis action cannot be undone.`)) {
        return;
    }
    
    // Show loading state
    const deleteBtn = event.target;
    const originalText = deleteBtn.textContent;
    deleteBtn.textContent = 'üîÑ Deleting...';
    deleteBtn.disabled = true;
    
    fetch(`/admin/students/${studentId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            // Redirect to students list
            window.location.href = data.redirect;
        } else {
            alert(`‚ùå Error: ${data.error}`);
            // Restore button state
            deleteBtn.textContent = originalText;
            deleteBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Delete request failed:', error);
        alert(`‚ùå Failed to delete student: ${error.message}`);
        // Restore button state
        deleteBtn.textContent = originalText;
        deleteBtn.disabled = false;
    });
}
</script>
{% endblock %}