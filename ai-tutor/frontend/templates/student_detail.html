{% extends "base.html" %}

{% block title %}{{ student.name }} - AI Tutor Admin{% endblock %}

{% block styles %}
<style>
    .progress-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: conic-gradient(#27ae60 var(--progress, 0%), #ecf0f1 0);
        margin: 0 auto 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .progress-circle-inner {
        width: 70px;
        height: 70px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .progress-circle-text {
        font-size: 1.2rem;
        font-weight: bold;
        color: #27ae60;
    }
    .grid-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    .progress-list, .goal-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .progress-item .progress-title {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    .progress-item .subject-name {
        font-weight: 600;
    }
    .progress-item .progress-percentage {
        color: #666;
    }
    .progress-bar-container {
        width: 100%;
        height: 8px;
        background: #ecf0f1;
        border-radius: 4px;
        overflow: hidden;
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #8e44ad);
        transition: width 0.3s ease;
    }
    .last-studied {
        margin-top: 5px;
        font-size: 0.9rem;
        color: #666;
    }
    .goal-item {
        padding: 12px;
        border-left-width: 4px;
        border-left-style: solid;
    }
    .goal-item.completed {
        border-left-color: #27ae60;
        background: #f0f9f0;
    }
    .goal-item.pending {
        border-left-color: #3498db;
        background: #f8f9fa;
    }
    .goal-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
    }
    .goal-title .completed {
        color: #27ae60;
    }
    .goal-title .pending {
        color: #3498db;
    }
    .goal-description {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 0.9rem;
    }
    .goal-target-date {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 0.8rem;
    }
   .engagement-score.score-4 { color: #27ae60; }
   .engagement-score.score-3 { color: #27ae60; }
   .engagement-score.score-2 { color: #f39c12; }
   .engagement-score.score-1 { color: #e74c3c; }
   .engagement-score.score-0 { color: #e74c3c; }
</style>
{% endblock %}
{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('admin_dashboard') }}">ğŸ“Š Dashboard</a> / 
    <a href="{{ url_for('admin_students') }}">ğŸ‘¥ Students</a> / 
    <span>{{ student.name }}</span>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="color: #2c3e50;">{{ student.name }}</h1>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('edit_student', student_id=student.id) }}" class="btn" style="background: #f39c12; text-decoration: none;">
            âœï¸ Edit Student
        </a>
        <button class="btn btn-danger" onclick="deleteStudent('{{ student.id }}', '{{ student.name }}')">
            ğŸ—‘ï¸ Delete
        </button>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem; margin-bottom: 2rem;">
    <div class="card">
        <h2>ğŸ‘¤ Student Information</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <label style="font-weight: 600; color: #666;">Student ID</label>
                <p style="margin: 5px 0 15px 0; font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 4px;">{{ student.id }}</p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Student Type</label>
                <p style="margin: 5px 0 15px 0;">
                    {% if profile.student_type %}
                        {% if profile.student_type == 'local' %}
                            <span style="background: #e8f5e8; color: #2d5a3d; padding: 6px 12px; border-radius: 12px;">
                                {{ profile.student_type|title }}
                            </span>
                        {% else %}
                            <span style="background: #fff3cd; color: #856404; padding: 6px 12px; border-radius: 12px;">
                                {{ profile.student_type|title }}
                            </span>
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">Not specified</span>
                    {% endif %}
                </p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">First Name</label>
                <p style="margin: 5px 0 15px 0;">{{ profile.first_name or 'Not provided' }}</p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Last Name</label>
                <p style="margin: 5px 0 15px 0;">{{ profile.last_name or 'Not provided' }}</p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Date of Birth</label>
                <p style="margin: 5px 0 15px 0;">
                    {% if profile.date_of_birth %}
                        ğŸ“… {{ profile.date_of_birth }}
                    {% else %}
                        <span style="color: #6c757d;">Not provided</span>
                    {% endif %}
                </p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Grade Level</label>
                <p style="margin: 5px 0 15px 0;">
                    <span style="background: #e8f5e8; color: #2d5a3d; padding: 6px 12px; border-radius: 12px;">
                        {{ student.grade }}
                    </span>
                </p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Age</label>
                <p style="margin: 5px 0 15px 0;">{{ student.age }}</p>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Phone Number</label>
                <p style="margin: 5px 0 15px 0;">
                    {% if student.phone %}
                        <span style="color: #27ae60;">ğŸ“± {{ student.phone }}</span>
                    {% else %}
                        <span style="color: #e74c3c;">âŒ Not configured</span>
                    {% endif %}
                </p>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label style="font-weight: 600; color: #666;">Interests</label>
                <div style="margin: 5px 0 15px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                    {% for interest in student.interests %}
                        <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 0.9rem;">
                            {{ interest }}
                        </span>
                    {% endfor %}
                </div>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label style="font-weight: 600; color: #666;">Learning Preferences</label>
                <div style="margin: 5px 0 15px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                    {% for preference in student.learning_preferences %}
                        <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 12px; font-size: 0.9rem;">
                            {{ preference }}
                        </span>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Timestamps Section -->
            <div style="grid-column: 1 / -1; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                <label style="font-weight: 600; color: #666; margin-bottom: 0.5rem; display: block;">ğŸ“… Record Timestamps</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem; color: #666;">
                    <div>
                        <strong>Created:</strong>
                        {% if profile.created_at %}
                            {{ profile.created_at.split('T')[0] if 'T' in profile.created_at else profile.created_at.split(' ')[0] }}
                            <span style="color: #999;">{{ profile.created_at.split('T')[1][:8] if 'T' in profile.created_at else (profile.created_at.split(' ')[1][:8] if ' ' in profile.created_at else '') }}</span>
                        {% else %}
                            <span style="color: #6c757d;">Unknown</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong>Last Updated:</strong>
                        {% if profile.updated_at %}
                            {{ profile.updated_at.split('T')[0] if 'T' in profile.updated_at else profile.updated_at.split(' ')[0] }}
                            <span style="color: #999;">{{ profile.updated_at.split('T')[1][:8] if 'T' in profile.updated_at else (profile.updated_at.split(' ')[1][:8] if ' ' in profile.updated_at else '') }}</span>
                        {% else %}
                            <span style="color: #6c757d;">Unknown</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div class="card" style="text-align: center;">
            <h3 style="margin-bottom: 1rem;">ğŸ“ˆ Progress Overview</h3>
            <div class="progress-circle" style="--progress: {{ progress.overall_progress }}%;">
                <div class="progress-circle-inner">
                    <span class="progress-circle-text">{{ progress.overall_progress }}%</span>
                </div>
            </div>
            <p style="color: #666; font-size: 0.9rem;">Overall Progress</p>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom: 1rem;">ğŸ“Š Quick Stats</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Sessions:</span>
                    <strong>{{ session_count }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Last Active:</span>
                    <strong>{{ last_session or 'Never' }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Streak:</span>
                    <strong>{{ progress.streak_days }} days</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="grid-container">
    <div class="card">
        <h2>ğŸ“š Subject Progress</h2>
        {% if progress.subjects %}
            <div class="progress-list">
                {% for subject, data in progress.subjects.items() %}
                <div class="progress-item">
                    <div class="progress-title">
                        <span class="subject-name">{{ subject.title() }}</span>
                        <span class="progress-percentage">{{ data.progress }}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="--progress-width: {{ data.progress }}%;"></div>
                    </div>
                    <div class="last-studied">
                        Last studied: {{ data.last_studied or 'Never' }}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="empty-state">No progress data available</p>
        {% endif %}
    </div>
    
    <div class="card">
        <h2>ğŸ¯ Learning Goals</h2>
        {% if progress.goals %}
            <div class="goal-list">
                {% for goal in progress.goals %}
                <div class="goal-item pending">
                    <div class="goal-title">
                        <span>{{ goal }}</span>
                        <span>ğŸ¯</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="empty-state">No learning goals set</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <h2>ğŸ“ Cumulative Assessment</h2>
    {% if assessment and assessment.subjects %}
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            {% for subject, data in assessment.subjects.items() %}
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h3 style="color: #2c3e50; margin-bottom: 1rem;">{{ subject.title() }}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="font-weight: 600; color: #666;">Mastery Level</label>
                        <p style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">{{ (data.overall_mastery * 100)|round }}%</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #666;">Last Assessed</label>
                        <p>{{ data.last_assessed.split('T')[0] }}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #666;">Strengths</label>
                        <ul style="padding-left: 20px;">
                            {% for strength in data.strengths %}
                                <li>{{ strength }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #666;">Weaknesses</label>
                         <ul style="padding-left: 20px;">
                            {% for weakness in data.weaknesses %}
                                <li style="color: #c0392b;">{{ weakness }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label style="font-weight: 600; color: #666;">Knowledge Gaps</label>
                        <ul style="padding-left: 20px;">
                            {% for gap in data.knowledge_gaps %}
                                <li>{{ gap }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="color: #666; font-style: italic;">No assessment data available for this student.</p>
    {% endif %}
</div>

<!-- Student Subjects and Curriculum Information -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="color: #2c3e50; margin: 0;">ğŸ“š Student Subjects & Curriculum</h2>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            {% if progress.grade_filter_applied and progress.subjects_filtered_count > 0 %}
            <button
                id="gradeFilterToggle"
                class="btn"
                style="background: #28a745; color: white; font-size: 0.8rem; padding: 6px 12px;"
                onclick="toggleGradeFilter()"
                title="Currently showing Grade {{ progress.student_grade }} subjects only. Click to show all {{ progress.subjects_filtered_count + progress.student_subjects_detailed|length }} subjects."
            >
                ğŸ“š Grade {{ progress.student_grade }} ({{ progress.student_subjects_detailed|length }})
            </button>
            {% elif not progress.grade_filter_applied and progress.student_grade and progress.student_grade != 'Unknown' %}
            <button
                id="gradeFilterToggle"
                class="btn"
                style="background: #6c757d; color: white; font-size: 0.8rem; padding: 6px 12px;"
                onclick="toggleGradeFilter()"
                title="Currently showing all {{ progress.student_subjects_detailed|length }} subjects. Click to show only Grade {{ progress.student_grade }} subjects."
            >
                ğŸ“š All Subjects ({{ progress.student_subjects_detailed|length }})
            </button>
            {% endif %}
            <button
                class="btn"
                style="background: #17a2b8; color: white; font-size: 0.8rem; padding: 6px 12px;"
                onclick="debugStudentSubjects('{{ student.id }}')"
                title="Debug curriculum assignment issues"
            >
                ğŸ” Debug
            </button>
            <button
                class="btn"
                style="background: #dc3545; color: white; font-size: 0.8rem; padding: 6px 12px;"
                onclick="deleteAndReassignCurriculum('{{ student.id }}', '{{ student.name }}')"
                title="Delete all current assignments and reassign default curriculum"
            >
                ğŸ”„ Reset Curriculum
            </button>
        </div>
    </div>
    
    {% if progress.student_subjects_detailed %}
        <div style="margin-bottom: 1rem;">
            {% if progress.grade_filter_applied and progress.subjects_filtered_count > 0 %}
            <div id="filterInfo" style="background: #e8f5e8; border-left: 4px solid #28a745; padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #155724;">ğŸ“š Grade-Relevant Subjects (Default)</strong>
                        <p style="color: #155724; margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                            Showing {{ progress.student_subjects_detailed|length }} subjects for Grade {{ progress.student_grade }}
                            ({{ progress.subjects_filtered_count }} other grade subjects available)
                        </p>
                    </div>
                    <button
                        onclick="toggleGradeFilter()"
                        style="background: #fff; border: 1px solid #28a745; color: #28a745; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                        Show All {{ progress.subjects_filtered_count + progress.student_subjects_detailed|length }}
                    </button>
                </div>
            </div>
            {% else %}
            <div style="background: #f8f9fa; border-left: 4px solid #6c757d; padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #495057;">ğŸ“š All Subjects Displayed</strong>
                        <p style="color: #495057; margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                            Showing all {{ progress.student_subjects_detailed|length }} subjects assigned to this student across all grade levels.
                        </p>
                    </div>
                    {% if progress.student_grade and progress.student_grade != 'Unknown' %}
                    <button
                        onclick="toggleGradeFilter()"
                        style="background: #28a745; border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                        Show Grade {{ progress.student_grade }} Only
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        {% for subject in progress.student_subjects_detailed %}
        <div class="subject-detail-section" style="margin-bottom: 2rem; border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; background: #f8f9fa;">
            <!-- Subject Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h3 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        ğŸ“– {{ subject.subject_name }}
                        {% if subject.is_core_subject %}
                        <span class="badge" style="background: #e74c3c; color: white; font-size: 0.7rem;">CORE</span>
                        {% endif %}
                        {% if subject.is_mandatory %}
                        <span class="badge" style="background: #f39c12; color: white; font-size: 0.7rem;">MANDATORY</span>
                        {% endif %}
                    </h3>
                    <p style="color: #7f8c8d; margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                        {{ subject.subject_description or 'No description available' }}
                    </p>
                    <div style="margin-top: 0.5rem;">
                        <span class="badge" style="background: #3498db; color: white; font-size: 0.7rem;">{{ subject.subject_category or 'General' }}</span>
                        <span class="badge" style="background: #7f8c8d; color: white; font-size: 0.7rem;">Grade {{ subject.grade_level }}</span>
                        {% if subject.curriculum_is_default %}
                        <span class="badge" style="background: #27ae60; color: white; font-size: 0.7rem;">DEFAULT CURRICULUM</span>
                        {% endif %}
                    </div>
                </div>
                <div style="text-align: right;">
                    {% if subject.is_active_for_tutoring %}
                    <span class="badge" style="background: #27ae60; color: white;">ACTIVE</span>
                    {% else %}
                    <span class="badge" style="background: #95a5a6; color: white;">INACTIVE</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Subject Details Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <!-- Learning Goals & Objectives -->
                <div>
                    <h4 style="color: #34495e; margin: 0 0 0.5rem 0; font-size: 1rem;">ğŸ¯ Learning Objectives</h4>
                    {% if subject.learning_objectives %}
                    <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; color: #555;">
                        {% for objective in subject.learning_objectives %}
                        <li style="margin-bottom: 0.25rem;">{{ objective }}</li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p style="color: #7f8c8d; font-style: italic; margin: 0;">No learning objectives defined</p>
                    {% endif %}
                    
                    {% if subject.goals_description %}
                    <div style="margin-top: 0.75rem;">
                        <h5 style="color: #34495e; margin: 0 0 0.25rem 0; font-size: 0.9rem;">ğŸ“ Goals Description</h5>
                        <p style="color: #555; font-size: 0.9rem; margin: 0;">{{ subject.goals_description }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Assessment & Progress -->
                <div>
                    <h4 style="color: #34495e; margin: 0 0 0.5rem 0; font-size: 1rem;">ğŸ“Š Student Progress</h4>
                    
                    <!-- Progress Metrics -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
                        {% if subject.progress_percentage is not none %}
                        <div>
                            <span style="font-size: 0.8rem; color: #7f8c8d;">Progress:</span>
                            <div style="font-weight: bold; color: #27ae60;">{{ subject.progress_percentage }}%</div>
                        </div>
                        {% endif %}
                        
                        {% if subject.completion_percentage is not none %}
                        <div>
                            <span style="font-size: 0.8rem; color: #7f8c8d;">Completion:</span>
                            <div style="font-weight: bold; color: #3498db;">{{ subject.completion_percentage }}%</div>
                        </div>
                        {% endif %}
                        
                        {% if subject.mastery_level %}
                        <div>
                            <span style="font-size: 0.8rem; color: #7f8c8d;">Mastery:</span>
                            <div style="font-weight: bold; color: #9b59b6;">{{ subject.mastery_level|title }}</div>
                        </div>
                        {% endif %}
                        
                        {% if subject.grade_score %}
                        <div>
                            <span style="font-size: 0.8rem; color: #7f8c8d;">Grade:</span>
                            <div style="font-weight: bold; color: #e67e22;">{{ subject.grade_score }}</div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Assessment Criteria -->
                    {% if subject.assessment_criteria %}
                    <div style="margin-bottom: 0.75rem;">
                        <h5 style="color: #34495e; margin: 0 0 0.25rem 0; font-size: 0.85rem;">ğŸ“‹ Assessment Criteria</h5>
                        <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                            {% for criteria in subject.assessment_criteria %}
                            <span style="background: #ecf0f1; color: #2c3e50; padding: 2px 6px; border-radius: 12px; font-size: 0.75rem;">{{ criteria }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Comments Section -->
            <div style="margin-top: 1rem; border-top: 1px solid #ecf0f1; padding-top: 1rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- Teacher Comments -->
                    <div>
                        <h5 style="color: #34495e; margin: 0 0 0.5rem 0; font-size: 0.9rem;">ğŸ‘©â€ğŸ« Teacher Notes & Comments</h5>
                        {% if subject.teacher_notes %}
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="font-size: 0.8rem; color: #856404;">Teacher Notes:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #856404;">{{ subject.teacher_notes }}</p>
                        </div>
                        {% endif %}
                        {% if subject.comments_teacher %}
                        <div style="background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 0.5rem;">
                            <strong style="font-size: 0.8rem; color: #0c5460;">Teacher Comments:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #0c5460;">{{ subject.comments_teacher }}</p>
                        </div>
                        {% endif %}
                        {% if not subject.teacher_notes and not subject.comments_teacher %}
                        <p style="color: #7f8c8d; font-style: italic; margin: 0; font-size: 0.85rem;">No teacher comments available</p>
                        {% endif %}
                    </div>
                    
                    <!-- AI Tutor Analysis -->
                    <div>
                        <h5 style="color: #34495e; margin: 0 0 0.5rem 0; font-size: 0.9rem;">ğŸ¤– AI Tutor Analysis</h5>
                        {% if subject.ai_tutor_notes %}
                        <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="font-size: 0.8rem; color: #155724;">AI Notes:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #155724;">{{ subject.ai_tutor_notes }}</p>
                        </div>
                        {% endif %}
                        {% if subject.ai_assessment %}
                        <div style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="font-size: 0.8rem; color: #721c24;">AI Assessment:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #721c24;">{{ subject.ai_assessment }}</p>
                        </div>
                        {% endif %}
                        {% if subject.weaknesses %}
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 0.5rem;">
                            <strong style="font-size: 0.8rem; color: #856404;">Areas for Improvement:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #856404;">{{ subject.weaknesses }}</p>
                        </div>
                        {% endif %}
                        {% if not subject.ai_tutor_notes and not subject.ai_assessment and not subject.weaknesses %}
                        <p style="color: #7f8c8d; font-style: italic; margin: 0; font-size: 0.85rem;">No AI analysis available</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Grade Motivation -->
                {% if subject.grade_motivation %}
                <div style="margin-top: 0.75rem; background: #e7f3ff; border-radius: 6px; padding: 0.75rem;">
                    <h6 style="color: #0066cc; margin: 0 0 0.25rem 0; font-size: 0.85rem;">ğŸ’ª Motivational Feedback</h6>
                    <p style="margin: 0; font-size: 0.9rem; color: #004080;">{{ subject.grade_motivation }}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Additional Information -->
            <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.85rem; color: #666;">
                {% if subject.recommended_hours_per_week %}
                <div>
                    <strong>Recommended Hours/Week:</strong> {{ subject.recommended_hours_per_week }}
                </div>
                {% endif %}
                <div>
                    <strong>Curriculum:</strong> {{ subject.curriculum_name }} ({{ subject.curriculum_type or 'General' }})
                </div>
                {% if subject.updated_at %}
                <div>
                    <strong>Last Updated:</strong> {{ subject.updated_at.split('T')[0] if 'T' in subject.updated_at else subject.updated_at }}
                </div>
                {% endif %}
            </div>
            
            <!-- Prerequisites and Resources -->
            {% if subject.prerequisites or subject.resources %}
            <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                {% if subject.prerequisites %}
                <div>
                    <h6 style="color: #34495e; margin: 0 0 0.25rem 0; font-size: 0.8rem;">ğŸ“‹ Prerequisites</h6>
                    <ul style="margin: 0; padding-left: 1rem; font-size: 0.75rem; color: #666;">
                        {% for prerequisite in subject.prerequisites %}
                        <li>{{ prerequisite }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if subject.resources %}
                <div>
                    <h6 style="color: #34495e; margin: 0 0 0.25rem 0; font-size: 0.8rem;">ğŸ“š Resources</h6>
                    <ul style="margin: 0; padding-left: 1rem; font-size: 0.75rem; color: #666;">
                        {% for resource in subject.resources %}
                        <li>{{ resource }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
    <div style="text-align: center; padding: 2rem; color: #666;">
        <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸ“š</div>
        <h4>No Subjects Assigned</h4>
        <p>This student doesn't have any subjects assigned yet.</p>
        <p style="color: #7f8c8d; font-size: 0.9rem;">
            Subjects are automatically assigned when students are created if a default curriculum is available.
        </p>
        <div style="margin-top: 1.5rem;">
            <button
                class="btn"
                style="background: #27ae60; color: white; text-decoration: none;"
                onclick="assignDefaultCurriculum('{{ student.id }}', '{{ student.name }}')"
            >
                ğŸ“š Assign Default Curriculum
            </button>
        </div>
    </div>
    {% endif %}
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>ğŸ•’ Recent Sessions</h2>
        <a href="{{ url_for('view_student_sessions', student_id=student.id) }}" class="btn">
            ğŸ“ View All Sessions
        </a>
    </div>
    
    {% if recent_sessions %}
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>ğŸ“… Date</th>
                        <th>â±ï¸ Duration</th>
                        <th>ğŸ“š Topics Covered</th>
                        <th>ğŸ“Š Engagement</th>
                        <th>âš¡ Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in recent_sessions %}
                    <tr>
                        <td>{{ session.date }}</td>
                        <td>{{ session.duration }} min</td>
                        <td>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                {% for topic in session.topics %}
                                    <span style="background: #e8f5e8; color: #2d5a3d; padding: 2px 6px; border-radius: 8px; font-size: 0.8rem;">
                                        {{ topic }}
                                    </span>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <span class="engagement-score score-{{ session.engagement // 20 }}">
                                {{ session.engagement }}%
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('view_session_detail', student_id=student.id, session_id=session.id) }}"
                               class="btn"
                               style="padding: 4px 8px; font-size: 0.8rem;">
                                ğŸ‘ï¸ View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 2rem; color: #666;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸ•’</div>
            <h4>No Sessions Yet</h4>
            <p>This student hasn't had any tutoring sessions yet.</p>
        </div>
    {% endif %}
</div>

<script>
function deleteStudent(studentId, studentName) {
    if (!confirm(`Are you sure you want to delete student "${studentName}"?\n\nThis action will permanently delete:\nâ€¢ Student profile and data\nâ€¢ All session records\nâ€¢ Phone number mapping\n\nThis action cannot be undone.`)) {
        return;
    }
    
    // Show loading state
    const deleteBtn = event.target;
    const originalText = deleteBtn.textContent;
    deleteBtn.textContent = 'ğŸ”„ Deleting...';
    deleteBtn.disabled = true;
    
    fetch(`/admin/students/${studentId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`âœ… ${data.message}`);
            // Redirect to students list
            window.location.href = data.redirect;
        } else {
            alert(`âŒ Error: ${data.error}`);
            // Restore button state
            deleteBtn.textContent = originalText;
            deleteBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Delete request failed:', error);
        alert(`âŒ Failed to delete student: ${error.message}`);
        // Restore button state
        deleteBtn.textContent = originalText;
        deleteBtn.disabled = false;
    });
}

function assignDefaultCurriculum(studentId, studentName) {
    if (!confirm(`Assign default curriculum to "${studentName}"?\n\nThis will add all subjects from the default Cambridge Primary 2025 curriculum to this student.`)) {
        return;
    }
    
    // Show loading state
    const assignBtn = event.target;
    const originalText = assignBtn.textContent;
    assignBtn.textContent = 'ğŸ”„ Assigning...';
    assignBtn.disabled = true;
    
    fetch(`/admin/students/${studentId}/assign-curriculum`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`âœ… ${data.message}`);
            // Reload the page to show the assigned subjects
            window.location.reload();
        } else {
            alert(`âŒ Error: ${data.error}`);
            // Restore button state
            assignBtn.textContent = originalText;
            assignBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Assign curriculum request failed:', error);
        alert(`âŒ Failed to assign curriculum: ${error.message}`);
        // Restore button state
        assignBtn.textContent = originalText;
        assignBtn.disabled = false;
    });
}

function debugStudentSubjects(studentId) {
    // Show loading state
    const debugBtn = event.target;
    const originalText = debugBtn.textContent;
    debugBtn.textContent = 'ğŸ”„ Debugging...';
    debugBtn.disabled = true;
    
    fetch(`/admin/debug/student/${studentId}/subjects`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create a detailed debug report
            let debugReport = `=== CURRICULUM DEBUG REPORT ===\n`;
            debugReport += `Student ID: ${data.debug_info.student_id}\n\n`;
            
            debugReport += `ğŸ“Š SUMMARY:\n`;
            debugReport += `â€¢ Total StudentSubject records: ${data.debug_info.total_student_subjects}\n`;
            debugReport += `â€¢ Detailed subjects query matches: ${data.debug_info.detailed_subjects_count}\n`;
            debugReport += `â€¢ Admin query successful: ${data.debug_info.admin_query_successful}\n`;
            
            if (data.debug_info.default_curriculum) {
                debugReport += `â€¢ Default curriculum exists: ${data.debug_info.default_curriculum.exists}\n`;
                if (data.debug_info.default_curriculum.exists) {
                    debugReport += `â€¢ Default curriculum: ${data.debug_info.default_curriculum.name} (ID: ${data.debug_info.default_curriculum.id})\n`;
                }
            }
            
            debugReport += `\nğŸ“‹ RAW STUDENT SUBJECT RECORDS:\n`;
            if (data.debug_info.student_subjects_raw.length > 0) {
                data.debug_info.student_subjects_raw.forEach((ss, index) => {
                    debugReport += `${index + 1}. ID: ${ss.id}, Curriculum Detail ID: ${ss.curriculum_detail_id}\n`;
                    debugReport += `   Active: ${ss.is_active_for_tutoring}, In Use: ${ss.is_in_use}\n`;
                    debugReport += `   Progress: ${ss.progress_percentage}%, Created: ${ss.created_at}\n\n`;
                });
            } else {
                debugReport += `No StudentSubject records found.\n`;
            }
            
            debugReport += `\nğŸ“š DETAILED SUBJECTS INFO:\n`;
            if (data.debug_info.detailed_subjects_info.length > 0) {
                data.debug_info.detailed_subjects_info.forEach((subj, index) => {
                    debugReport += `${index + 1}. ${subj.subject_name} (Grade ${subj.grade_level})\n`;
                    debugReport += `   Curriculum: ${subj.curriculum_name} (Default: ${subj.curriculum_is_default})\n`;
                    debugReport += `   Category: ${subj.subject_category}, Mandatory: ${subj.is_mandatory}\n`;
                    debugReport += `   Progress: ${subj.progress_percentage}%, Active: ${subj.is_active_for_tutoring}\n`;
                    debugReport += `   Learning Objectives: ${subj.learning_objectives_count}, Assessment Criteria: ${subj.assessment_criteria_count}\n\n`;
                });
            } else {
                debugReport += `No detailed subject information found.\n`;
            }
            
            if (data.debug_info.admin_query_error) {
                debugReport += `\nâŒ ADMIN QUERY ERROR:\n${data.debug_info.admin_query_error}\n`;
            }
            
            if (data.debug_info.default_curriculum_error) {
                debugReport += `\nâŒ DEFAULT CURRICULUM ERROR:\n${data.debug_info.default_curriculum_error}\n`;
            }
            
            // Show the debug report in an alert (for now) - could be improved with a modal
            alert(debugReport);
        } else {
            alert(`âŒ Debug Error: ${data.error}`);
        }
        
        // Restore button state
        debugBtn.textContent = originalText;
        debugBtn.disabled = false;
    })
    .catch(error => {
        console.error('Debug request failed:', error);
        alert(`âŒ Failed to debug student subjects: ${error.message}`);
        // Restore button state
        debugBtn.textContent = originalText;
        debugBtn.disabled = false;
    });
}

function deleteAndReassignCurriculum(studentId, studentName) {
    if (!confirm(`âš ï¸ RESET CURRICULUM for "${studentName}"?\n\nThis will:\nâ€¢ DELETE all existing subject assignments\nâ€¢ REASSIGN the complete default curriculum\n\nThis action cannot be undone. Continue?`)) {
        return;
    }
    
    // Show loading state
    const resetBtn = event.target;
    const originalText = resetBtn.textContent;
    resetBtn.textContent = 'ğŸ”„ Resetting...';
    resetBtn.disabled = true;
    
    fetch(`/admin/students/${studentId}/delete-and-reassign-curriculum`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `âœ… ${data.message}`;
            if (data.deleted_count > 0) {
                message += `\n\nğŸ“‹ Deleted Subjects:`;
                data.deleted_subjects.forEach((subj, index) => {
                    message += `\n${index + 1}. ${subj.subject_name} (Grade ${subj.grade_level}) - ${subj.curriculum_name}`;
                });
            }
            alert(message);
            // Reload the page to show the new assignments
            window.location.reload();
        } else {
            alert(`âŒ Error: ${data.error}`);
            // Restore button state
            resetBtn.textContent = originalText;
            resetBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Reset curriculum request failed:', error);
        alert(`âŒ Failed to reset curriculum: ${error.message}`);
        // Restore button state
        resetBtn.textContent = originalText;
        resetBtn.disabled = false;
    });
}

// Toggle function for grade filtering - default is filtered, toggle shows all
function toggleGradeFilter() {
    // Simple page reload approach - more reliable than complex DOM manipulation
    const currentUrl = new URL(window.location);
    const isCurrentlyShowingAll = currentUrl.searchParams.get('show_all') === 'true' || currentUrl.searchParams.get('grade_filter') === 'false';
    
    // Clean up old parameters
    currentUrl.searchParams.delete('grade_filter');
    currentUrl.searchParams.delete('show_all');
    
    if (isCurrentlyShowingAll) {
        // Currently showing all, switch to grade filter (default behavior - no parameters needed)
        // Don't add any parameters - default is grade filtering
    } else {
        // Currently showing grade filter (default), switch to show all subjects
        currentUrl.searchParams.set('show_all', 'true');
    }
    
    // Reload page with new filter state
    window.location.href = currentUrl.toString();
}
</script>
{% endblock %}