{% extends "base.html" %}

{% block title %}System - AI Tutor Admin{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('admin_dashboard') }}">📊 Dashboard</a> / <span>⚙️ System</span>
</div>

<h1 style="margin-bottom: 2rem; color: #2c3e50;">System Settings & Monitoring</h1>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
    <div class="card">
        <h2>📱 Phone Number Mappings</h2>
        <p style="color: #666; margin-bottom: 1rem;">Manage phone number to student ID mappings for automated identification during calls.</p>
        
        {% if phone_mappings %}
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>📱 Phone Number</th>
                            <th>👤 Student</th>
                            <th>⚡ Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for phone, student_id in phone_mappings.items() %}
                        <tr>
                            <td style="font-family: monospace;">{{ phone }}</td>
                            <td>
                                {% if students_info[student_id] %}
                                    <a href="{{ url_for('admin_student_detail', student_id=student_id) }}" 
                                       style="color: #3498db; text-decoration: none;">
                                       {{ students_info[student_id].name }}
                                    </a>
                                    <br>
                                    <span style="color: #666; font-size: 0.9rem;">ID: {{ student_id }}</span>
                                {% else %}
                                    <span style="color: #e74c3c;">⚠ Student not found</span>
                                    <br>
                                    <span style="color: #666; font-size: 0.9rem;">ID: {{ student_id }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-danger" 
                                        style="padding: 4px 8px; font-size: 0.8rem;"
                                        onclick="alert('Remove mapping functionality coming in Phase 2!')">
                                    🗑️ Remove
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div style="text-align: center; padding: 2rem; color: #666; background: #f8f9fa; border-radius: 4px;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">📱</div>
                <h4>No Phone Mappings</h4>
                <p>No phone numbers are currently mapped to students.</p>
            </div>
        {% endif %}
        
        <div style="margin-top: 1rem; text-align: center;">
            <button class="btn btn-success" onclick="alert('Add mapping functionality coming in Phase 2!')">
                ➕ Add Phone Mapping
            </button>
        </div>
    </div>
    
    <div class="card">
        <h2>📊 System Statistics</h2>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <span style="font-weight: 600;">Total Students:</span>
                <span style="color: #3498db; font-weight: bold;">{{ system_stats.total_students }}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <span style="font-weight: 600;">Total Sessions:</span>
                <span style="color: #27ae60; font-weight: bold;">{{ system_stats.total_sessions }}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <span style="font-weight: 600;">Phone Mappings:</span>
                <span style="color: #e67e22; font-weight: bold;">{{ system_stats.phone_mappings }}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <span style="font-weight: 600;">Data Directory Size:</span>
                <span style="color: #9b59b6; font-weight: bold;">{{ system_stats.data_size }}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <span style="font-weight: 600;">Last Backup:</span>
                <span style="color: #666; font-weight: bold;">{{ system_stats.last_backup or 'Never' }}</span>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h2>🔧 System Health</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="padding: 1rem; border: 2px solid #27ae60; border-radius: 4px; background: #f0f9f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;">MCP Server</span>
                <span style="color: #27ae60; font-size: 1.2rem;">✅</span>
            </div>
            <p style="color: #666; font-size: 0.9rem; margin: 0;">Running on port {{ mcp_port or '3001' }}</p>
        </div>
        
        <div style="padding: 1rem; border: 2px solid #27ae60; border-radius: 4px; background: #f0f9f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;">Data Directory</span>
                <span style="color: #27ae60; font-size: 1.2rem;">✅</span>
            </div>
            <p style="color: #666; font-size: 0.9rem; margin: 0;">Accessible and writable</p>
        </div>
        
        <div style="padding: 1rem; border: 2px solid #27ae60; border-radius: 4px; background: #f0f9f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;">Admin Dashboard</span>
                <span style="color: #27ae60; font-size: 1.2rem;">✅</span>
            </div>
            <p style="color: #666; font-size: 0.9rem; margin: 0;">Online and responsive</p>
        </div>
        
        <div style="padding: 1rem; border: 2px solid {% if vapi_status %}#27ae60{% else %}#f39c12{% endif %}; border-radius: 4px; background: {% if vapi_status %}#f0f9f0{% else %}#fef9e7{% endif %};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;">VAPI Integration</span>
                <span style="color: {% if vapi_status %}#27ae60{% else %}#f39c12{% endif %}; font-size: 1.2rem;">
                    {% if vapi_status %}✅{% else %}⚠️{% endif %}
                </span>
            </div>
            <p style="color: #666; font-size: 0.9rem; margin: 0;">
                {% if vapi_status %}Connected and ready{% else %}Not configured{% endif %}
            </p>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
    <div class="card">
        <h2>📁 Data Management</h2>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <button class="btn" onclick="alert('Backup functionality coming in Phase 2!')">
                💾 Create Backup
            </button>
            
            <button class="btn" style="background: #f39c12;" onclick="alert('Restore functionality coming in Phase 2!')">
                📥 Restore from Backup
            </button>
            
            <button class="btn" style="background: #e74c3c;" onclick="if(confirm('This will clear all session logs. Are you sure?')) alert('Clear logs functionality coming in Phase 2!')">
                🗑️ Clear Session Logs
            </button>
            
            <a href="{{ url_for('admin_files') }}" class="btn" style="background: #3498db;">
                📂 Browse Data Directory
            </a>
        </div>
    </div>
    
    <div class="card">
        <h2>⚙️ Configuration</h2>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
                <label style="font-weight: 600; color: #666;">Admin Password</label>
                <div style="display: flex; gap: 1rem; margin-top: 5px;">
                    <button class="btn" onclick="alert('Change password functionality coming in Phase 2!')">
                        🔑 Change Password
                    </button>
                </div>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Session Timeout</label>
                <div style="display: flex; gap: 1rem; margin-top: 5px; align-items: center;">
                    <input type="number" value="30" min="5" max="120" style="width: 80px; padding: 6px;">
                    <span style="color: #666;">minutes</span>
                    <button class="btn" onclick="alert('Update timeout functionality coming in Phase 2!')">
                        💾 Update
                    </button>
                </div>
            </div>
            
            <div>
                <label style="font-weight: 600; color: #666;">Auto-backup</label>
                <div style="display: flex; gap: 1rem; margin-top: 5px; align-items: center;">
                    <select style="padding: 6px;">
                        <option>Daily</option>
                        <option>Weekly</option>
                        <option>Monthly</option>
                        <option>Disabled</option>
                    </select>
                    <button class="btn" onclick="alert('Update auto-backup functionality coming in Phase 2!')">
                        💾 Update
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 2rem;">
    <h2>📋 Recent System Events</h2>
    {% if system_events %}
        <div style="max-height: 300px; overflow-y: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>🕐 Time</th>
                        <th>📌 Event</th>
                        <th>👤 User</th>
                        <th>📊 Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in system_events %}
                    <tr>
                        <td style="font-family: monospace; font-size: 0.9rem;">{{ event.timestamp }}</td>
                        <td>{{ event.message }}</td>
                        <td>{{ event.user or 'System' }}</td>
                        <td>
                            <span style="color: {% if event.status == 'success' %}#27ae60{% elif event.status == 'warning' %}#f39c12{% else %}#e74c3c{% endif %};">
                                {% if event.status == 'success' %}✅{% elif event.status == 'warning' %}⚠️{% else %}❌{% endif %}
                                {{ event.status.title() }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 2rem; color: #666;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">📋</div>
            <h4>No Recent Events</h4>
            <p>No system events have been logged recently.</p>
        </div>
    {% endif %}
</div>
{% endblock %}